<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <div th:replace="~{fragments/head :: head}"></div>
    <title>ë§ˆì´í˜ì´ì§€ - MockerView</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f8f9fa;
        color: #1a1a1a;
      }

      .navbar {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 16px 0;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }
      .navbar-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .navbar-brand {
        font-size: 1.375rem;
        font-weight: 700;
        color: #667eea;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .plan-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.6875rem;
        font-weight: 700;
        letter-spacing: 0.5px;
      }
      .plan-badge.free {
        background: #f3f4f6;
        color: #6b7280;
      }
      .plan-badge.basic {
        background: #dbeafe;
        color: #1e40af;
      }
      .plan-badge.pro {
        background: #fce7f3;
        color: #9f1239;
      }
      .plan-badge.team {
        background: #f0fdf4;
        color: #166534;
      }

      .navbar-nav {
        display: flex;
        gap: 20px;
        align-items: center;
      }
      .nav-link {
        color: #4a5568;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9375rem;
        transition: color 0.2s;
      }
      .nav-link:hover,
      .nav-link.active {
        color: #667eea;
      }

      .page-header {
        padding: 40px 0 28px;
      }
      .page-title h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #0a0a0a;
        letter-spacing: -0.5px;
        margin-bottom: 6px;
      }
      .page-title p {
        font-size: 0.9375rem;
        color: #6b7280;
      }

      .content-grid {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 28px;
        margin-bottom: 40px;
      }
      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .profile-card {
        background: white;
        border-radius: 14px;
        padding: 28px 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        text-align: center;
      }

      .profile-avatar {
        width: 70px;
        height: 70px;
        background: #667eea;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        color: white;
        margin: 0 auto 16px;
        font-weight: 700;
      }

      .profile-name {
        font-size: 1.125rem;
        font-weight: 700;
        color: #0a0a0a;
        margin-bottom: 4px;
      }
      .profile-email {
        font-size: 0.8125rem;
        color: #6b7280;
        margin-bottom: 14px;
      }
      .profile-role {
        display: inline-block;
        padding: 5px 12px;
        background: #f0f4ff;
        color: #667eea;
        border-radius: 16px;
        font-size: 0.8125rem;
        font-weight: 600;
      }

      .quick-actions {
        background: white;
        border-radius: 14px;
        padding: 18px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }
      .quick-actions h3 {
        font-size: 0.8125rem;
        font-weight: 700;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 14px;
      }

      .action-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        padding: 11px 14px;
        background: white;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        color: #1a1a1a;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        margin-bottom: 8px;
      }
      .action-btn:hover {
        border-color: #667eea;
        background: #fafbfc;
      }
      .action-icon {
        font-size: 1.125rem;
      }

      .main-content {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .section-card {
        background: white;
        border-radius: 14px;
        padding: 28px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .section-header h2 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #0a0a0a;
        letter-spacing: -0.5px;
      }

      .btn {
        padding: 9px 18px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.875rem;
        text-decoration: none;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: none;
        cursor: pointer;
      }
      .btn-primary {
        background: #667eea;
        color: white;
      }
      .btn-primary:hover {
        background: #5568d3;
      }
      .btn-danger {
        background: #dc2626;
        color: white;
      }
      .btn-danger:hover {
        background: #b91c1c;
      }

      .subscription-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 18px;
        margin-bottom: 20px;
      }
      .info-box {
        padding: 18px;
        background: #f9fafb;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
      }
      .info-label {
        font-size: 0.75rem;
        color: #6b7280;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }
      .info-value {
        font-size: 1.375rem;
        font-weight: 700;
        color: #667eea;
      }

      .progress-bar {
        width: 100%;
        height: 7px;
        background: #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 10px;
      }
      .progress-fill {
        height: 100%;
        background: #667eea;
        border-radius: 8px;
        transition: width 0.3s;
      }

      .form-group {
        margin-bottom: 18px;
      }
      .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 8px;
      }
      .form-input {
        width: 100%;
        padding: 11px 14px;
        font-size: 0.9375rem;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        transition: all 0.2s;
      }
      .form-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      .form-input:disabled {
        background: #f9fafb;
        color: #9ca3af;
        cursor: not-allowed;
      }

      .report-card {
        padding: 18px;
        background: #fafbfc;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        margin-bottom: 12px;
        transition: all 0.2s;
        cursor: pointer;
      }
      .report-card:hover {
        border-color: #667eea;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        transform: translateY(-2px);
      }

      .report-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
      }
      .report-info h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #0a0a0a;
        margin-bottom: 4px;
      }
      .report-meta {
        font-size: 0.8125rem;
        color: #6b7280;
      }

      .report-scores {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }
      .score-box {
        text-align: center;
        padding: 10px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }
      .score-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #667eea;
      }
      .score-label {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 2px;
      }

      @media (max-width: 1024px) {
        .content-grid {
          grid-template-columns: 1fr;
        }
        .report-scores {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .container {
          padding: 0 16px;
        }
        .section-card {
          padding: 20px;
        }
        .report-scores {
          grid-template-columns: 1fr;
        }
      }
    </style>
    <div th:replace="~{fragments/styles :: styles}"></div>
  </head>
  <body>
    <!--   <nav class="navbar">
      <div class="container">
          <div class="navbar-content">
              <a class="navbar-brand" href="/session/list">
                  MockerView
                  <span
                  class="plan-badge"
                  th:classappend="${subscription != null && subscription.planType != null ? subscription.planType.name().toLowerCase() : 'free'}"
                  th:text="${subscription != null && subscription.planType != null ? subscription.planType.name() : 'FREE'}"
                  >FREE</span
                  >
                </a>
          <div class="navbar-nav">
            <a class="nav-link" th:href="@{/session/list}">ì„¸ì…˜ ëª©ë¡</a>
            <a class="nav-link active" th:href="@{/auth/mypage}">ë§ˆì´í˜ì´ì§€</a>
            <a
              class="nav-link"
              th:if="${user.role.name() == 'ADMIN'}"
              th:href="@{/admin/dashboard}"
              >ê´€ë¦¬ì</a
            >
            <a class="nav-link" th:href="@{/auth/logout}">ë¡œê·¸ì•„ì›ƒ</a>
          </div>
        </div>
      </div>
    </nav>-->

    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <div class="page-header">
      <div class="container">
        <div class="page-title">
          <h1>ë§ˆì´í˜ì´ì§€</h1>
          <p>ê³„ì • ì •ë³´ ë° êµ¬ë… ê´€ë¦¬</p>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="content-grid">
        <div class="sidebar">
          <div class="profile-card">
            <div
              class="profile-avatar"
              th:text="${#strings.substring(user.name, 0, 1)}"
            >
              í™
            </div>
            <div class="profile-name" th:text="${user.name}">í™ê¸¸ë™</div>
            <div class="profile-email" th:text="${user.email}">
              hong@example.com
            </div>
            <span class="profile-role">
              <span th:if="${user.role.name() == 'STUDENT'}">ğŸ“ ë©´ì ‘ì</span>
              <span th:if="${user.role.name() == 'HOST'}">ğŸ’¼ ë©´ì ‘ê´€</span>
              <span th:if="${user.role.name() == 'REVIEWER'}">ğŸ“ ë¦¬ë·°ì–´</span>
              <span th:if="${user.role.name() == 'ADMIN'}">âš¡ ê´€ë¦¬ì</span>
            </span>
          </div>

          <div class="quick-actions">
            <h3>ë¹ ë¥¸ ë©”ë‰´</h3>
            <a href="/session/list" class="action-btn">
              <span class="action-icon">ğŸ </span>
              ì„¸ì…˜ ëª©ë¡
            </a>
            <a href="/auth/mypage/stats" class="action-btn">
              <span class="action-icon">ğŸ“Š</span>
              í™œë™ í†µê³„
            </a>
            <a href="/selfinterview/create-ai" class="action-btn">
              <span class="action-icon">ğŸ¯</span>
              ì…€í”„ ë©´ì ‘
            </a>
            <a href="/selfinterview/videos" class="action-btn">
              <span class="action-icon">ğŸ¬</span>
              ë…¹í™” ì˜ìƒ ë³´ê¸°
            </a>
            <a href="/user/consent-management" class="action-btn">
              <span class="action-icon">ğŸ”’</span>
              ê°œì¸ì •ë³´ ë™ì˜ ê´€ë¦¬
            </a>
            <a href="/payment/plans" class="action-btn">
              <span class="action-icon">ğŸ’³</span>
              í”Œëœ ì—…ê·¸ë ˆì´ë“œ
            </a>
          </div>
        </div>

        <div class="main-content">
          <div class="section-card">
            <div class="section-header">
              <h2>êµ¬ë… ì •ë³´</h2>
              <a href="/payment/plans" class="btn btn-primary">í”Œëœ ë³€ê²½</a>
            </div>

            <div class="subscription-info">
              <div class="info-box">
                <div class="info-label">í˜„ì¬ í”Œëœ</div>
                <div
                  class="info-value"
                  th:text="${subscription != null && subscription.planType != null ? subscription.planType.name() : 'FREE'}"
                >
                  FREE
                </div>
              </div>

              <div class="info-box">
                <div class="info-label">ì„¸ì…˜ ì‚¬ìš©ëŸ‰</div>
                <div class="info-value">
                  <span
                    th:text="${subscription != null && subscription.usedSessions != null ? subscription.usedSessions : 0}"
                    >0</span
                  >
                  <span style="font-size: 0.875rem; color: #6b7280">/ </span>
                  <span
                    style="font-size: 0.875rem; color: #6b7280"
                    th:text="${subscription != null && subscription.sessionLimit != null ? subscription.sessionLimit : 5}"
                    >5</span
                  >
                </div>
                <div class="progress-bar">
                  <div
                    class="progress-fill"
                    th:style="'width: ' + ${subscription != null && subscription.sessionLimit != null && subscription.sessionLimit > 0 ? (subscription.usedSessions * 100 / subscription.sessionLimit) : 0} + '%'"
                  ></div>
                </div>
              </div>

              <div class="info-box">
                <div class="info-label">ë¦¬ë·° ì½ê¸°</div>
                <div class="info-value">
                  <span
                    th:text="${subscription != null && subscription.usedReviewReads != null ? subscription.usedReviewReads : 0}"
                    >0</span
                  >
                  <span style="font-size: 0.875rem; color: #6b7280">/ </span>
                  <span
                    style="font-size: 0.875rem; color: #6b7280"
                    th:text="${subscription != null && subscription.reviewReadLimit != null ? (subscription.reviewReadLimit == 2147483647 ? 'ë¬´ì œí•œ' : subscription.reviewReadLimit) : 3}"
                    >3</span
                  >
                </div>
                <div
                  class="progress-bar"
                  th:if="${subscription != null && subscription.reviewReadLimit != null && subscription.reviewReadLimit != 2147483647}"
                >
                  <div
                    class="progress-fill"
                    th:style="'width: ' + ${subscription.reviewReadLimit > 0 ? (subscription.usedReviewReads * 100 / subscription.reviewReadLimit) : 0} + '%'"
                  ></div>
                </div>
              </div>
            </div>
          </div>

          <div class="section-card">
            <div class="section-header">
              <h2>ğŸ¯ ì…€í”„ ë©´ì ‘ ë¦¬í¬íŠ¸</h2>
              <a
                href="/selfinterview/videos"
                style="
                  color: #667eea;
                  text-decoration: none;
                  font-size: 0.875rem;
                  font-weight: 600;
                "
              >
                ì „ì²´ë³´ê¸° (<span th:text="${totalReports}">0</span>) â†’
              </a>
            </div>

            <div th:if="${selfReports != null and !selfReports.isEmpty()}">
              <div
                th:each="report : ${selfReports}"
                class="report-card"
                th:onclick="'location.href=\'/self-interview/reports/' + ${report.id} + '\''"
              >
                <div class="report-header">
                  <div class="report-info">
                    <h3 th:text="${report.categoryName}">ì¹´í…Œê³ ë¦¬</h3>
                    <div class="report-meta">
                      <span th:text="${report.questionType}">TECHNICAL</span> Â·
                      ë‚œì´ë„ <span th:text="${report.difficulty}">1</span> Â·
                      ì§ˆë¬¸ <span th:text="${report.totalQuestions}">5</span>ê°œ Â·
                      <span
                        th:text="${#temporals.format(report.createdAt, 'MM-dd HH:mm')}"
                        >01-01 10:00</span
                      >
                    </div>
                  </div>
                </div>
                <div class="report-scores">
                  <div class="score-box">
                    <div
                      class="score-value"
                      th:text="${report.overallAvg != null ? report.overallAvg : '-'}"
                    >
                      -
                    </div>
                    <div class="score-label">ì¢…í•©</div>
                  </div>
                  <div class="score-box">
                    <div
                      class="score-value"
                      th:text="${report.textAvg != null ? report.textAvg : '-'}"
                    >
                      -
                    </div>
                    <div class="score-label">í…ìŠ¤íŠ¸</div>
                  </div>
                  <div class="score-box">
                    <div
                      class="score-value"
                      th:text="${report.audioAvg != null ? report.audioAvg : '-'}"
                    >
                      -
                    </div>
                    <div class="score-label">ìŒì„±</div>
                  </div>
                  <div class="score-box">
                    <div
                      class="score-value"
                      th:text="${report.videoAvg != null ? report.videoAvg : '-'}"
                    >
                      -
                    </div>
                    <div class="score-label">ì˜ìƒ</div>
                  </div>
                </div>
              </div>
            </div>

            <div
              th:if="${selfReports == null or selfReports.isEmpty()}"
              style="text-align: center; padding: 40px 20px; color: #9ca3af"
            >
              <div style="font-size: 3rem; margin-bottom: 12px">ğŸ¯</div>
              <div style="font-weight: 600; color: #6b7280; margin-bottom: 8px">
                ì•„ì§ ì…€í”„ ë©´ì ‘ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤
              </div>
              <div style="font-size: 0.875rem; margin-bottom: 16px">
                AIì™€ í•¨ê»˜ í˜¼ìì„œë„ ë©´ì ‘ ì—°ìŠµì„ ì‹œì‘í•´ë³´ì„¸ìš”
              </div>
              <a href="/selfinterview/create-ai" class="btn btn-primary"
                >ì…€í”„ ë©´ì ‘ ì‹œì‘í•˜ê¸°</a
              >
            </div>
          </div>

          <div class="section-card">
            <div class="section-header">
              <h2>ê³„ì • ì •ë³´</h2>
            </div>

            <form th:action="@{/auth/mypage/update}" method="post">
              <div class="form-group">
                <label class="form-label" for="username">ì•„ì´ë””</label>
                <input
                  type="text"
                  id="username"
                  class="form-input"
                  th:value="${user.username}"
                  disabled
                />
              </div>

              <div class="form-group">
                <label class="form-label" for="name">ì´ë¦„</label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  class="form-input"
                  th:value="${user.name}"
                  required
                />
              </div>

              <div class="form-group">
                <label class="form-label" for="email">ì´ë©”ì¼</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  class="form-input"
                  th:value="${user.email}"
                  required
                />
              </div>

              <button type="submit" class="btn btn-primary">ì •ë³´ ìˆ˜ì •</button>
            </form>
          </div>

          <div class="section-card">
            <div class="section-header">
              <h2>ğŸ”’ ê°œì¸ì •ë³´ ê´€ë¦¬</h2>
            </div>

            <p
              style="color: #6b7280; margin-bottom: 18px; font-size: 0.9375rem"
            >
              ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜ ë‚´ì—­ì„ í™•ì¸í•˜ê³  ë§ˆì¼€íŒ… ìˆ˜ì‹  ë™ì˜ë¥¼
              ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>

            <a href="/user/consent-management" class="btn btn-primary">
              ê°œì¸ì •ë³´ ë™ì˜ ê´€ë¦¬
            </a>
          </div>

          <div class="section-card">
            <div class="section-header">
              <h2>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
            </div>

            <form id="changePasswordForm">
              <div class="form-group">
                <label class="form-label" for="currentPassword"
                  >í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label
                >
                <input
                  type="password"
                  id="currentPassword"
                  name="currentPassword"
                  class="form-input"
                  placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸"
                  required
                />
              </div>

              <div class="form-group">
                <label class="form-label" for="newPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                <input
                  type="password"
                  id="newPassword"
                  name="newPassword"
                  class="form-input"
                  placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (8ì ì´ìƒ)"
                  required
                  minlength="8"
                />
              </div>

              <div class="form-group">
                <label class="form-label" for="confirmNewPassword"
                  >ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label
                >
                <input
                  type="password"
                  id="confirmNewPassword"
                  class="form-input"
                  placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
                  required
                />
              </div>

              <button type="submit" class="btn btn-primary">
                ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
              </button>
            </form>
          </div>

          <div class="section-card">
            <div class="section-header">
              <h2>íšŒì› íƒˆí‡´</h2>
            </div>

            <p
              style="color: #6b7280; margin-bottom: 18px; font-size: 0.9375rem"
            >
              íƒˆí‡´ ì‹œ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹ ì¤‘í•˜ê²Œ
              ê²°ì •í•´ì£¼ì„¸ìš”.
            </p>

            <button onclick="confirmWithdrawal()" class="btn btn-danger">
              íšŒì› íƒˆí‡´
            </button>
          </div>
        </div>
      </div>
    </div>
    <div th:replace="~{fragments/chat-widget :: messageWidget}"></div>
    <button th:replace="~{fragments/chat-widget :: messageWidgetBtn}"></button>
    <div th:replace="~{fragments/chat-widget :: toast}"></div>
    <div th:replace="~{fragments/footer :: footer}"></div>
    <div th:replace="~{fragments/scripts :: scripts}"></div>

    <script>
      function confirmWithdrawal() {
        if (confirm("íšŒì› íƒˆí‡´ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          window.location.href = "/auth/mypage/withdraw";
        }
      }

      document
        .getElementById("changePasswordForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const currentPassword =
            document.getElementById("currentPassword").value;
          const newPassword = document.getElementById("newPassword").value;
          const confirmPassword =
            document.getElementById("confirmNewPassword").value;

          if (newPassword !== confirmPassword) {
            alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
          }

          try {
            const response = await fetch("/api/users/change-password", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include",
              body: JSON.stringify({
                currentPassword: currentPassword,
                newPassword: newPassword,
              }),
            });

            const data = await response.json();

            if (data.success) {
              alert("ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
              document.getElementById("changePasswordForm").reset();
            } else {
              alert(data.message || "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        });
    </script>
  </body>
</html>
