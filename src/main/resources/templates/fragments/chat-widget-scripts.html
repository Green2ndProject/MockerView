<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<script th:fragment="chat-widget-scripts">

    class PrivateMessageWebsocket {

    constructor(currentUserName, onMessageReceived){
        this.currentUserName = currentUserName,
        this.onMessageReceived = onMessageReceived,
        this.stompClient = null;
        this.connected = false;
    }

    

    getTokenFromCookie(){
        const cookies = document.cookie.split(';');
        for(let cookie of cookies){
            const [name, value] = cookie.trim().split('=');
            if(name === 'Authorization') return value;
        }

        return null;
    }

    connect(){

        const token = this.getTokenFromCookie();
        if(!token){
            console.error('âŒ í† í° ì—†ìŒ. 1:1 ì±„íŒ… ì—°ê²° ì‹¤íŒ¨.');
            return;
        }

        const socket = new SockJS("/ws");
        this.stompClient = Stomp.over(socket);
        this.stompClient.debug = null;

        this.stompClient.connect({}, (frame)=> {
            console.log("âœ… [PrivateMessage] STOMP ì—°ê²° ì„±ê³µ");
            this.connected = true;
            this.subscribePrivateQueue();
        }, (error)=> {
            console.error("âŒ [PrivateMessage] WebSocket ì—°ê²° ì‹¤íŒ¨:", error);
            this.connect = false;
        });
    }

    subscribePrivateQueue(){

        this.stompClient.subscribe('/user/queue/messages', (message) => {
            console.log('âœ‰ï¸ [PrivateChat] ê°œì¸ ë©”ì‹œì§€ ìˆ˜ì‹ ');
            const privateMessage = JSON.parse(message.body);
            if(typeof this.onMessageReceived === 'function'){
                this.onMessageReceived(privateMessage);
            }
        });

        console.log('âœ… [PrivateMessage] ê°œì¸ í êµ¬ë… ì™„ë£Œ: /user/queue/messages');
    }

    sendPrivateMessage(receiverUsername, content){
        if(!this.connected){
            console.error('âŒ [PrivateMessage] ì—°ê²° ì•ˆ ë¨. ë©”ì‹œì§€ ì „ì†¡ ë¶ˆê°€.')
            return;
        };

        const messagePayload = JSON.stringify({
            receiverUsername: receiverUsername,
            content: content
        });

        this.stompClient.send("/app/private/message", {}, messagePayload);
    }
}

window.currentChatPartner = null;
window.privateMessageWsClient = null;



function handleReceivedMessage(message){
    console.log(`[ì±„íŒ… ìœ„ì ¯] ìƒˆ ë©”ì‹œì§€: ${message.senderUsername} -> ${message.content}`);

    if(message.senderUsername === window.currentChatPartner || message.receiverUsername === window.currentChatPartner){

        displayMessageInHistory(message);
    }else{
        // í˜„ì¬ ì—´ë ¤ìˆëŠ” ì±„íŒ…ë°©ì´ ì•„ë‹ˆë¼ë©´, ì½ì§€ì•Šì€ ë©”ì‹œì§€ ìˆ˜ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë¡œì§
        // updateUnreadCount();
    }

    //displayMessageInWidget(message.senderUsername, message.content, message.sentAt);

}

async function fetchMessageHistory(targetUsername){

    const API_BASE_URL = 'http://localhost:8080';
    const API_URL      = `${API_BASE_URL}/api/private/messages/${encodeURIComponent(targetUsername)}`;

    const token = PrivateMessageWebsocket.prototype.getTokenFromCookie();

    if(!token){
        console.error('âŒ í† í°ì´ ì—†ì–´ ë©”ì‹œì§€ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    try {
        const response = await fetch(API_URL, {

            method: 'GET',
            credentials: 'include'
        });

        if(!response.ok){
            throw new Error(`ë©”ì‹œì§€ ë‚´ì—­ ë¡œë”© ì‹¤íŒ¨ : HTTP ${response.status}`);
        }

        const history = await response.json();
        console.log(`âœ… ${targetUsername}ê³¼ì˜ ë©”ì‹œì§€ ë‚´ì—­ ${history.length}ê°œ ì¡°íšŒ`);
        return history;        
        
    }catch(error){
        console.error('âŒ ë©”ì‹œì§€ ë‚´ì—­ ì¡°íšŒ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒ:', error);
        throw error;
    }
}

async function openMessageWindow(targetUsername){

    const chatHeader = document.getElementById('chat-header').querySelector('h4');
    const messageHistory = document.getElementById('message-history');
    const sendBtn = document.getElementById('send-btn');
    
    messageHistory.innerHTML = '';

    chatHeader.textContent = `${targetUsername}ê³¼ ëŒ€í™”ì¤‘`;
    
    window.currentChatPartner = targetUsername;
    sendBtn.disabled = false;

    try{
        const history = await fetchMessageHistory(targetUsername);

        history.forEach(msg => displayMessageInHistory(msg));

        messageHistory.scrollTop = messageHistory.scrollHeight;

    }catch(error){
        console.error('ì±„íŒ…ë°© ì—´ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);

        messageHistory.innerHTML = '<div class="error-message">ë©”ì‹œì§€ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }

    //clearMessageDisplay();

    //messageHistory.forEach(msg => {
        // uiì— ë©”ì‹œì§€ í‘œì‹œí•˜ëŠ” ì‹¤ì œ ë¡œì§
    //    displayMessageInWidget(msg.senderUsername, msg.content, msg.sentAt);
    //});

    if(!window.privateMessageWsClient.connected){
        window.privateMessageWsClient.connect();
    }

}

function displayMessageInHistory(message){

    const messageHistory = document.getElementById('message-history');
    const myUsername     = getCurrentUsername();

    const isMe = message.senderUsername === myUsername;

    const messageElement = document.createElement('div');
    messageElement.className = isMe ? 'message-bubble my-message' : 'message-bubble their-message';

    const senderName = isMe ? 'ë‚˜' : message.senderUsername;
    const time = new Date(message.sentAt).toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
    messageElement.innerHTML = `
        <span class="sender-name">${senderName}</span>
        <div class="message-content">${message.content}</div>
        <span class="message-item">${time}</span>
    `

    messageHistory.appendChild(messageElement);

    messageHistory.scrollTop = messageHistory.scrollHeight;

}

function setupMessageEvents(){
    const sendBtn = document.getElementById('send-btn');
    const messageInput  = document.getElementById('message-input');

    const handleSendMessage = () => {
        const content = messageInput.value.trim();
        const receiverUsername = window.currentChatPartner;
        
        if(content && receiverUsername && window.privateMessageWsClient){

            window.privateMessageWsClient.sendPrivateMessage(receiverUsername, content);

            const sentMessage = {
                senderUsername: getCurrentUsername(),
                content: content,
                sentAt: new Date().toISOString()
            };

            displayMessageInHistory(sentMessage);

            messageInput.value = '';
        }
    };

    sendBtn.addEventListener('click', handleSendMessage);
    messageInput.addEventListener('keypress', (e)=>{

        if(e.key === 'Enter' && !e.shiftKey){

            e.preventDefault();
            handleSendMessage();
        }
    });

    sendBtn.disabled = true;
    
}

function searchAndDisplayUsers(keyword){

    if(keyword.length < 2){
        document.getElementById('search-results').innerHTML = '';
        return;
    }

    fetch(`/api/users/search?q=${encodeURIComponent(keyword)}`)
        .then(response => response.json())
        .then(users => {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';

            users.forEach(user => {
                
                const userItem = document.createElement('div');
                userItem.className = 'user-search-item';
                userItem.innerText = `${user.name} (${user.username})`; 

                userItem.onclick = () => startPrivateChat(user.name, user.username);

                resultsContainer.appendChild(userItem);
            });
        })
        .catch(error => console.error('ìœ ì € ê²€ìƒ‰ ì‹¤íŒ¨:', error));
}

function debounce(func, delay){
    let timeout;
    return function(...args){
        clearTimeout(timeout);
        timeout = setTimeout(()=> func.apply(this, args), delay);
    }
}

function setupSearchHandler(){
    const searchInput = document.getElementById('candidate-search');

    searchInput.addEventListener('input', debounce(handleSearchInput, 300));
}

function handleSearchInput(event){
    const query = event.target.value.trim();
    if(query.length > 1){
        fetchSearchUsers(query);
    }else{
        const candidateList = document.getElementById('candidate-list');
        candidateList.innerHTML = '';
    }
}

async function fetchSearchUsers(query){

    const API_BASE_URL = 'http://localhost:8080';
    const API_URL = `${API_BASE_URL}/api/users/search?q=${encodeURIComponent(query)}`;
    const token = PrivateMessageWebsocket.prototype.getTokenFromCookie();

    if(!token){
        console.error('ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ê²€ìƒ‰ ì‹¤íŒ¨');
        return;
    }

    try {
        const response = await fetch(API_URL, {
            method: 'GET',
            headers: {
                'Content-Type':'application/json'
            }
        });

        if(!response.ok){
            throw new Error(`HTTP ì—ëŸ¬ : ${response.status}`);
        }

        const users = await response.json();

        handleSearchResults(users);

    }catch(error){
        console.error('ì‚¬ìš©ì ê²€ìƒ‰ ì‹¤íŒ¨', error);
    }

}

function handleSearchResults(users){
    
    const candidateList = document.getElementById('candidate-list');
    candidateList.innerHTML = '';

    if(users.length === 0){
        candidateList.innerHTML = '<li class="no-result">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
        return;
    }

    users.forEach(user => {
        const item = createCandidateItem(user);
        
        candidateList.appendChild(item);
    });
}

function createCandidateItem(user){

    const listItem = document.createElement('li');

    listItem.className = 'candidate-item';
    listItem.setAttribute('data-username', user.username);

    listItem.innerHTML = `
        <span class="name">${user.name} (${user.username})</span>
        <span class="status online">â—</span><span class="badge hidden">0</span>
    `;

    listItem.addEventListener('click', handleCandidateClick);

    return listItem;
}

function handleCandidateClick(event){

    const listItem = event.currentTarget;

    const targetUsername = listItem.getAttribute('data-username');

    if(targetUsername){

        console.log(`[í´ë¦­] ${targetUsername}ì™€ì˜ ì±„íŒ…ë°©ì„ ì—½ë‹ˆë‹¤.`);

        window.currentChatPartner = targetUsername;
    }

    openMessageWindow(targetUsername);
}


function startPrivateChat(targetname, targetusername){

    console.log(`ğŸ’¬ ${targetname} (${targetusername})ì™€ ëŒ€í™” ì‹œì‘.`);

    document.getElementById('chat-widget').style.display = 'block';

    window.currentChatPartnerId = targetname;
    window.currentChatPartnerName = targetusername;

    //    (ì„ íƒì ) ì´ì „ì— ì£¼ê³ ë°›ì€ ë©”ì‹œì§€ ëª©ë¡ì„ ì„œë²„ REST APIë¡œ ë¶ˆëŸ¬ì™€ í‘œì‹œ
    //    fetch(`/api/messages/${targetUserId}`).then(...)
}

function setupWidgetToggle(){

    const toggleBtn = document.getElementById('chat-toggle-btn');
    const container = document.getElementById('chat-widget-container');
    const closexBtn = document.querySelector('.close-x-btn');

    if(!toggleBtn || !container){
        console.error("ì±„íŒ… ìœ„ì ¯ì˜ HTML ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    toggleBtn.addEventListener('click', ()=>{

        const isActive = container.classList.toggle('active');

        if(isActive){
            toggleBtn.classList.add('hidden-by-widget');
        }else{
            toggleBtn.classList.remove('hidden-by-widget');
        }
        
    });

    const chatHeader = document.getElementById('chat-header');

    if(chatHeader){
        chatHeader.addEventListener('click', ()=>{
            if(container.classList.contains('active')){
                container.classList.remove('active');
                toggleBtn.classList.remove('hidden-by-widget');
            }
        });
    }

    closexBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        container.classList.remove('active');
        toggleBtn.classList.remove('hidden-by-widget');
    });

}

function getCurrentUsername(){

    const hiddenInputField = document.getElementById('current-user-username-data');

    if(hiddenInputField && hiddenInputField.dataset.username){

        return hiddenInputField.dataset.username;
    }

    return null;
}

document.addEventListener('DOMContentLoaded', ()=>{
      
    const myUsername = getCurrentUsername(); // ë°›ì•„ì™€ì•¼í•¨

    if(myUsername){
        window.privateMessageWsClient = new PrivateMessageWebsocket(myUsername, handleReceivedMessage);

        window.privateMessageWsClient.connect();

        setupSearchHandler();

        setupWidgetToggle();

        setupMessageEvents();
    }else{

        console.warn("ì‚¬ìš©ì ì •ë³´ ì—†ìŒ. ì±„íŒ… ìœ„ì ¯ì„ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.");

    }
});


</script>

</body>
</html>
