<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<script th:fragment="chat-widget-scripts">

    class PrivateMessageWebsocket {

    constructor(currentUserName, onMessageReceived){
        this.currentUserName = currentUserName,
        this.onMessageReceived = onMessageReceived,
        this.stompClient = null;
        this.connected = false;
    }

    

    async getTokenFromCookie(){
        
        const URI_TOKEN = '/api/auth/gettoken';

        try{
            const response = await fetch(URI_TOKEN, {
                method: 'GET',
                headers: {
                    'Content-Type':'application/json'
                }
            });

            if(!response.ok){
                throw new Error('ì¸ì¦ í† í°ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }

            const data = await response.json();

            return data.Authorization;

        }catch(error){

            console.error('WebSocket í† í° íšë“ ì˜¤ë¥˜ : ', error);
            return null;
        }
    }

    async connect(){

        const token = await this.getTokenFromCookie();

        if(!token){
            console.error('âŒ í† í° ì—†ìŒ. 1:1 ì±„íŒ… ì—°ê²° ì‹¤íŒ¨.');
            return;
        }

        const headers = {
            'Authorization':`Bearer ${token}`
        }

        const socket = new SockJS("/ws");
        this.stompClient = Stomp.over(socket);
        this.stompClient.debug = null;

        this.stompClient.connect(headers, (frame)=> {

            console.log("âœ… [PrivateMessage] STOMP ì—°ê²° ì„±ê³µ");
            this.connected = true;
            
            if (!this.stompClient || !this.stompClient.connected) {
                console.error('STOMP í´ë¼ì´ì–¸íŠ¸ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            // êµ¬ë… ì—°ê²° ë¶€ë¶„~~~~~~
            // /user/queue/messages - ë©”ì‹œì§€ ë°›ëŠ” êµ¬ë…
            this.stompClient.subscribe('/user/queue/messages', (message) => {
                console.log('âœ‰ï¸ [PrivateChat] ê°œì¸ ë©”ì‹œì§€ ìˆ˜ì‹ ');
                const privateMessage = JSON.parse(message.body);
                if(typeof this.onMessageReceived === 'function'){

                    this.onMessageReceived(privateMessage);

                    console.log('âœ… [PrivateMessage] ê°œì¸ í êµ¬ë… ì™„ë£Œ: /user/queue/messages');
                }

                const activePartner = document.getElementById('chat-header').dataset.partner;

                if(privateMessage.senderUsername === activePartner){
                    this.stompClient.send("/app/messages/read", {}, JSON.stringify({
                        partnerUsername : activePartner
                    }));
                }
            });
            // /user/queue/messagelist-update - ì‹¤ì‹œê°„ ë©”ì‹œì§€ ëª©ë¡ ì—…ë°ì´íŠ¸ ê°±ì‹  êµ¬ë…
            this.stompClient.subscribe('/user/queue/messagelist-update', onConversationUpdateReceived);

            console.log('âœ… [ChatList] ì±„íŒ… ëª©ë¡ ì—…ë°ì´íŠ¸ í êµ¬ë… ì™„ë£Œ');
            
            this.stompClient.subscribe('/user/queue/notification', onNotificationReceived);

            console.log('âœ… [notification] ë©”ì‹œì§€ ì•Œë¦¼ êµ¬ë… ì™„ë£Œ');
            
            // unreadCount ë±ƒì§€ ì—…ë°ì´íŠ¸ êµ¬ë…
            this.stompClient.subscribe('/user/queue/total-unread', (message) => {

                const newCount = message.body;

                console.log('âœ… [Badge] ë±ƒì§€ ì—…ë°ì´íŠ¸ ì‹ í˜¸ ìˆ˜ì‹ :', message.body);

                updateUnreadBadge(newCount);

            })

            fetch('/api/private/messages/unread/total') 
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Initial count fetch failed');
                    }
                    return response.json();
                })
                .then(count => {
                    updateUnreadBadge(count);
                })
                .catch(error => {
                    console.error("ì´ˆê¸° ì „ì²´ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ë¡œë”© ì‹¤íŒ¨:", error);
                });
//--------------------------------------------------------------------


        }, (error)=> {
                console.error("âŒ [PrivateMessage] WebSocket ì—°ê²° ì‹¤íŒ¨:", error);
                this.connect = false;
        });


    }

    subscribePrivateQueue(){        

        // this.stompClient.subscribe('/user/queue/messagelist-update', (message) => {
        //     console.log('âœ… [ChatList Update] ì±„íŒ… ëª©ë¡ ê°±ì‹  ì‹ í˜¸ ìˆ˜ì‹ ', message.body);

        //     const readerUsername = JSON.parse(message.body);

        //     if(typeof fetchAndRenderPartnerList === 'function'){
        //         fetchAndRenderPartnerList();
        //     }else{
        //         console.error('fetchAndRenderPartnerList í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        //     }

        //     //clearLocalUnreadBadge(readerUsername);

        // });

    }

    sendPrivateMessage(receiverUsername, content){
        if(!this.connected){
            console.error('âŒ [PrivateMessage] ì—°ê²° ì•ˆ ë¨. ë©”ì‹œì§€ ì „ì†¡ ë¶ˆê°€.')
            return;
        };

        const messagePayload = JSON.stringify({
            receiverUsername: receiverUsername,
            content: content
        });

        this.stompClient.send("/app/private/message", {}, messagePayload);
    }
}

window.currentChatPartner = null;
window.privateMessageWsClient = null;



function handleReceivedMessage(message){
    console.log(`[ì±„íŒ… ìœ„ì ¯] ìƒˆ ë©”ì‹œì§€: ${message.senderUsername} -> ${message.content}`);

    if(message.senderUsername === window.currentChatPartner || message.receiverUsername === window.currentChatPartner){

        displayMessageInHistory(message);
    }else{
        // í˜„ì¬ ì—´ë ¤ìˆëŠ” ì±„íŒ…ë°©ì´ ì•„ë‹ˆë¼ë©´, ì½ì§€ì•Šì€ ë©”ì‹œì§€ ìˆ˜ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë¡œì§
        // updateUnreadCount();
    }

    //displayMessageInWidget(message.senderUsername, message.content, message.sentAt);

}

async function fetchAndRenderPartnerList(){

    try{
        const response = await fetch('/api/private/messages/conversations');

        if(!response.ok){
            throw new Error('íŒŒíŠ¸ë„ˆ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

        const partnerList = await response.json();

        renderConversationList(partnerList);

    }catch(error){
        console.error('error : ', error);
    }
}

function renderConversationList(partnerList){

    const listContainer = document.getElementById('candidate-list');

    if(!listContainer){
        console.error('ì±„íŒ… ëª©ë¡ì„ í‘œì‹œí•  ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    let newHtml = '';
    listContainer.innerHTML = '';

    partnerList.forEach(partner => {
        
        const unreadCount = partner.unreadCount;
        const lastContent = partner.lastMessageContent || 'ëŒ€í™” ì‹œì‘';
        const lastTime    = partner.lastMessageSentAt ? new Date(partner.lastMessageSentAt).toLocaleTimeString() : '';
        const badgeHtml   = unreadCount > 0 
        ? `<span id="unread-badge-${partner.partnerUsername}" class="badge">${partner.unreadCount}</span>`
        : '';

        newHtml += `
            <li class="candidate-item" onclick="openMessageWindow('${partner.partnerUsername}')">
                <div class="info-text-area">
                    <span class="name">${partner.partnerUsername}</span>
                    <span class="last-message-snippet">${lastContent.substring(0,30)}...</span>
                </div>
                <div class="status-area">
                    <span class="message-time">${lastTime}...</span>
                    ${badgeHtml}
                </div>                
            </li>    
        `;
    });

    listContainer.innerHTML=newHtml;

}

function onConversationUpdateReceived(payload){
    const updatedList = JSON.parse(payload.body);
    renderConversationList(updatedList);
}

async function fetchMessageHistory(partnerUsername){

    const API_BASE_URL = 'http://localhost:8080';
    const API_URL      = `${API_BASE_URL}/api/private/messages/${encodeURIComponent(partnerUsername)}`;

    const token = PrivateMessageWebsocket.prototype.getTokenFromCookie();

    if(!token){
        console.error('âŒ í† í°ì´ ì—†ì–´ ë©”ì‹œì§€ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    try {
        const response = await fetch(API_URL, {

            method: 'GET',
            credentials: 'include'
        });

        if(!response.ok){
            throw new Error(`ë©”ì‹œì§€ ë‚´ì—­ ë¡œë”© ì‹¤íŒ¨ : HTTP ${response.status}`);
        }

        const history = await response.json();
        console.log(`âœ… ${partnerUsername}ê³¼ì˜ ë©”ì‹œì§€ ë‚´ì—­ ${history.length}ê°œ ì¡°íšŒ`);
        return history;        
        
    }catch(error){
        console.error('âŒ ë©”ì‹œì§€ ë‚´ì—­ ì¡°íšŒ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒ:', error);
        throw error;
    }
}

async function openMessageWindow(partnerUsername){

    const RESTORE_URL = `http://localhost:8080/api/private/messages/restore/${encodeURIComponent(partnerUsername)}`;

    try{
        await fetch(RESTORE_URL, {method: 'POST'});
        console.log(`ëŒ€í™”ë°© ìƒíƒœ ë³µêµ¬ ì™„ë£Œ : ${partnerUsername}`);
    }catch(e){
        console.error("ëŒ€í™”ë°© ìƒíƒœ ë³µêµ¬ ì‹¤íŒ¨", e);
    }

    const container = document.getElementById('chat-widget-container');
    const toggleBtn = document.getElementById('chat-toggle-btn');

    if(!container || !toggleBtn){
        console.error("ìœ„ì ¯ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const chatHeader = document.getElementById('chat-header');
    const h4 = chatHeader.querySelector('h4');
    const messageHistory = document.getElementById('message-history');
    const sendBtn = document.getElementById('send-btn');

    container.classList.add('active');
    toggleBtn.classList.add('hidden-by-widget');

    if(chatHeader){

        const headerTitle = chatHeader.querySelector('h4');
        const exitBtn = document.getElementById('exitConversation');

        if(headerTitle){
            headerTitle.innerHTML = `${partnerUsername}ê³¼ ëŒ€í™”ì¤‘`; 
        }
        
        if(exitBtn){
            exitBtn.classList.remove('hidden');
        }

        chatHeader.dataset.partner = partnerUsername;
    }

    messageHistory.innerHTML = '';

    window.currentChatPartner = partnerUsername;
    sendBtn.disabled = false;

    try{
        const history = await fetchMessageHistory(partnerUsername);

        history.forEach(msg => displayMessageInHistory(msg));

        messageHistory.scrollTop = messageHistory.scrollHeight;

        const response = await fetch(`/api/private/messages/read/${partnerUsername}`, {
            method : 'PUT',    
            headers: {'Content-Type' : 'application/json'},
                   
        });

        if(response.ok){
            
            console.log(`[Read Status] ${partnerUsername}ê³¼ì˜ ëŒ€í™”ë¥¼ ì½ìŒ ì²˜ë¦¬ ì™„ë£Œ`);

            clearLocalUnreadBadge(partnerUsername);
        }else{
            console.error(`[Read Status] ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ : `, response.status);
        }

    }catch(error){
        console.error('ì±„íŒ…ë°© ì—´ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);

        messageHistory.innerHTML = '<div class="error-message">ë©”ì‹œì§€ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }

    //clearMessageDisplay();

    //messageHistory.forEach(msg => {
        // uiì— ë©”ì‹œì§€ í‘œì‹œí•˜ëŠ” ì‹¤ì œ ë¡œì§
    //    displayMessageInWidget(msg.senderUsername, msg.content, msg.sentAt);
    //});

    if(!window.privateMessageWsClient.connected){
        window.privateMessageWsClient.connect();
    }

}

async function exitConversation(partnerUsername){

    const API_BASE_URL = 'http://localhost:8080';
    const API_URL = `${API_BASE_URL}/api/private/messages/exit/${encodeURIComponent(partnerUsername)}`;

    try {
        
        const response = await fetch(API_URL, {method: 'POST'});

        if(response.ok){
            alert(`${partnerUsername}ë‹˜ê³¼ì˜ ëŒ€í™”ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.`);

            closeChatWidget();
        }else{
            alert('ëŒ€í™”ë°© ë‚˜ê°€ê¸° ì‹¤íŒ¨');
        }

    } catch (error) {
        console.error('ëŒ€í™”ë°© ë‚˜ê°€ê¸°ì¤‘ ì—ëŸ¬ : ', error);
        alert('ì„œë²„ ì—°ê²° ì˜¤ë¥˜');
    }
    
}

function closeChatWidget(){
    const widgetContainer = document.getElementById('chat-widget-container');
    const toggleBtn = document.getElementById('chat-toggle-btn');
    const chatHeader = document.getElementById('chat-header');

    window.currentChatPartner = null;

    if(chatHeader && chatHeader.dataset.partner){
        chatHeader.removeAttribute('data-partner');        
    }

    if(chatHeader){
        const headerTitle = chatHeader.querySelector('h4');
        if(headerTitle){
            headerTitle.textContent = '[ëŒ€í™” ìƒíƒœë¥¼ ì„ íƒí•˜ì„¸ìš”]';
        }
    }

    const messageHistory = document.getElementById('message-history');

    if(messageHistory){
        messageHistory.innerHTML = '';
    }

    const exitBtn = document.getElementById('exitConversation');

    if(exitBtn){
        exitBtn.classList.add('hidden');
    }

    if (widgetContainer) {
        widgetContainer.classList.remove('active');
    }
    if (toggleBtn) {
        toggleBtn.classList.remove('hidden-by-widget');
    }
}

function clearLocalUnreadBadge(partnerUsername){
    const badgeElement = document.getElementById(`unread-badge-${partnerUsername}`);

    if(badgeElement){
        badgeElement.textContent = '0';
        badgeElement.style.display = 'none';
    }

}

function showToast(title, body, senderUsername){
    // ë©”ì‹œì§€ ì•Œë¦¼ í† ìŠ¤íŠ¸ í•¨ìˆ˜

    const toastContainer = document.getElementById('toast-container');

    if(!toastContainer){
        console.error('Toast container not found');
        return;
    }

    const toast = document.createElement('div');
    toast.classList.add('toast-notification');

    toast.onclick = () => {
        openMessageWindow(senderUsername);
        toast.remove();
    };

    toast.innerHTML = `
        <div class="toast-title">${title}</div>
        <div class="toast-body">${body}</div>
    `;

    toastContainer.appendChild(toast);

    setTimeout(()=> {
        toast.classList.add('show');
    }, 10);

    setTimeout(()=> {
        toast.classList.remove('show');

        toast.addEventListener('transitioned', () => toast.remove());
    }, 2000);

    console.log(`[ì•Œë¦¼]ì œëª© : ${title}, ë‚´ìš© : ${body}`)
   
    //alert(`[ìƒˆ ë©”ì‹œì§€] ${title}\në‚´ìš©: ${body}`);

}

function onNotificationReceived(payload){

    const notificationData = JSON.parse(payload.body);

    const sender = notificationData.senderUsername;
    const content = notificationData.messageSnippet;

    const chatHeader = document.getElementById('chat-header');
    const currentPartner = chatHeader ? chatHeader.dataset.partner : null;

    const chatWidgetContainer = document.getElementById('chat-widget-container');
    const isChatWidgetOpen = chatWidgetContainer && window.getComputedStyle(chatWidgetContainer).display !== 'none';

    if(isChatWidgetOpen && currentPartner === sender){
        console.log('í˜„ì¬ ëŒ€í™”ì¤‘ì¸ ìƒëŒ€ë°©ì˜ ë©”ì‹œì§€ì´ë¯€ë¡œ ì•Œë¦¼ ìŠ¤í‚µ');
        return;
    }
    
    showToast(`${sender}ë‹˜ì—ê²Œ ìƒˆ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.`, content, sender);
    
}

function displayMessageInHistory(message){

    const messageHistory = document.getElementById('message-history');
    const myUsername     = getCurrentUsername();

    const isMe = message.senderUsername === myUsername;

    const messageElement = document.createElement('div');
    messageElement.className = isMe ? 'message-container sender' : 'message-container receiver';

    const senderName = isMe ? 'ë‚˜' : message.senderUsername;
    const time = new Date(message.sentAt).toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
    messageElement.innerHTML = `
        <div class="sender-name">${senderName}</div>
        <div class="message-bubble">${message.content}</div>
        <div class="message-item" style="font-size : 12px;">${time}</div>
    `

    messageHistory.appendChild(messageElement);

    messageHistory.scrollTop = messageHistory.scrollHeight;

}

function setupMessageEvents(){
    const sendBtn = document.getElementById('send-btn');
    const messageInput  = document.getElementById('message-input');

    const handleSendMessage = () => {
        const content = messageInput.value.trim();
        const receiverUsername = window.currentChatPartner;
        
        if(content && receiverUsername && window.privateMessageWsClient){

            window.privateMessageWsClient.sendPrivateMessage(receiverUsername, content);

            const sentMessage = {
                senderUsername: getCurrentUsername(),
                content: content,
                sentAt: new Date().toISOString()
            };

            displayMessageInHistory(sentMessage);

            messageInput.value = '';
        }
    };

    sendBtn.addEventListener('click', handleSendMessage);
    messageInput.addEventListener('keypress', (e)=>{

        if(e.key === 'Enter' && !e.shiftKey){

            e.preventDefault();
            handleSendMessage();
        }
    });

    sendBtn.disabled = true;
    
}

function searchAndDisplayUsers(keyword){

    if(keyword.length < 2){
        document.getElementById('search-results').innerHTML = '';
        return;
    }

    fetch(`/api/users/search?q=${encodeURIComponent(keyword)}`)
        .then(response => response.json())
        .then(users => {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';

            users.forEach(user => {
                
                const userItem = document.createElement('div');
                userItem.className = 'user-search-item';
                userItem.innerText = `${user.name} (${user.username})`; 

                userItem.onclick = () => startPrivateChat(user.name, user.username);

                resultsContainer.appendChild(userItem);
            });
        })
        .catch(error => console.error('ìœ ì € ê²€ìƒ‰ ì‹¤íŒ¨:', error));
}

function debounce(func, delay){
    let timeout;
    return function(...args){
        clearTimeout(timeout);
        timeout = setTimeout(()=> func.apply(this, args), delay);
    }
}

function setupSearchHandler(){
    const searchInput = document.getElementById('candidate-search');

    searchInput.addEventListener('input', debounce(handleSearchInput, 300));
}

function handleSearchInput(event){
    const query = event.target.value.trim();

    if(query.length > 1){
        fetchSearchUsers(query);
    }else{
        const candidateList = document.getElementById('candidate-list');
        fetchAndRenderPartnerList();
    }    
}

async function fetchSearchUsers(query){

    const API_BASE_URL = 'http://localhost:8080';
    const API_URL = `${API_BASE_URL}/api/users/search?q=${encodeURIComponent(query)}`;
    const token = PrivateMessageWebsocket.prototype.getTokenFromCookie();

    if(!token){
        console.error('ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ê²€ìƒ‰ ì‹¤íŒ¨');
        return;
    }

    try {
        const response = await fetch(API_URL, {
            method: 'GET',
            headers: {
                'Content-Type':'application/json'
            }
        });

        if(!response.ok){
            throw new Error(`HTTP ì—ëŸ¬ : ${response.status}`);
        }

        const users = await response.json();

        handleSearchResults(users);

    }catch(error){
        console.error('ì‚¬ìš©ì ê²€ìƒ‰ ì‹¤íŒ¨', error);
    }

}

function handleSearchResults(users){
    
    const candidateList = document.getElementById('candidate-list');
    candidateList.innerHTML = '';

    if(users.length === 0){
        return;
    }

    users.forEach(user => {
        const item = createCandidateItem(user);
        
        candidateList.appendChild(item);
    });
}

function createCandidateItem(user){

    const listItem = document.createElement('li');

    listItem.className = 'candidate-item';
    listItem.setAttribute('data-username', user.username);

    listItem.innerHTML = `
        <span class="name">${user.name} (${user.username})</span>
        <span class="status online">â—</span><span class="badge hidden">0</span>
    `;

    listItem.addEventListener('click', handleCandidateClick);

    return listItem;
}

function handleCandidateClick(event){

    const listItem = event.currentTarget;

    const targetUsername = listItem.getAttribute('data-username');

    if(targetUsername){

        console.log(`[í´ë¦­] ${targetUsername}ì™€ì˜ ì±„íŒ…ë°©ì„ ì—½ë‹ˆë‹¤.`);

        window.currentChatPartner = targetUsername;
    }

    openMessageWindow(targetUsername);
}


function startPrivateChat(targetname, targetusername){

    console.log(`ğŸ’¬ ${targetname} (${targetusername})ì™€ ëŒ€í™” ì‹œì‘.`);

    document.getElementById('chat-widget').style.display = 'block';

    window.currentChatPartnerId = targetname;
    window.currentChatPartnerName = targetusername;

    //    (ì„ íƒì ) ì´ì „ì— ì£¼ê³ ë°›ì€ ë©”ì‹œì§€ ëª©ë¡ì„ ì„œë²„ REST APIë¡œ ë¶ˆëŸ¬ì™€ í‘œì‹œ
    //    fetch(`/api/messages/${targetUserId}`).then(...)
}

function resetActivePartnerState(){

    const chatHeader = document.getElementById('chat-header');

    window.currentChatPartner = null;

    if(chatHeader && chatHeader.dataset.partner){
        chatHeader.removeAttribute('data-partner');
    }

    if(chatHeader){
        // chatHeader.innerHTML = '<h4>[ëŒ€í™” ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš”]</h4><button id="chat-close-x-btn" class="close-x-btn">âœ–ï¸</button>';
        chatHeader.querySelector('h4').textContent = '[ëŒ€í™” ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš”]';
    }

    const messageHistory = document.getElementById('message-history');
    if(messageHistory){
        messageHistory.innerHTML = '';
    }
}

function closeChatWidget(){
    const widgetContainer = document.getElementById('chat-widget-container');
    const searchInput = document.getElementById('candidate-search');

    if(searchInput.value.trim() !== ''){
        searchInput.value = '';
        fetchAndRenderPartnerList();
    }

    resetActivePartnerState();

    if(widgetContainer){
        widgetContainer.classList.remove('open');
    }
}

function setupWidgetToggle(){

    const toggleBtn = document.getElementById('chat-toggle-btn');
    const container = document.getElementById('chat-widget-container');
    const closexBtn = document.querySelector('.close-x-btn');

    if(!toggleBtn || !container){
        console.error("ì±„íŒ… ìœ„ì ¯ì˜ HTML ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    
    //updateUnreadBadge();
    //setInterval(updateUnreadBadge, 60000);

    toggleBtn.addEventListener('click', ()=>{

        const isActive = container.classList.toggle('active');

        if(isActive){
            toggleBtn.classList.add('hidden-by-widget');

            const chatHeader = document.getElementById('chat-header');
            const exitBtn = document.getElementById('exitConversation');

            const currentPartner = chatHeader ? chatHeader.dataset.partner : null;

            if (exitBtn) {
                if (currentPartner) {
                    exitBtn.classList.remove('hidden');
                } else {
                    exitBtn.classList.add('hidden');
                }
            }
        }else{
            toggleBtn.classList.remove('hidden-by-widget');
        }
        
    });

    const chatHeader = document.getElementById('chat-header');

    if(chatHeader){
        chatHeader.addEventListener('click', ()=>{
            if(container.classList.contains('active')){
                container.classList.remove('active');
                toggleBtn.classList.remove('hidden-by-widget');
            }
        });
    }

    closexBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        container.classList.remove('active');
        toggleBtn.classList.remove('hidden-by-widget');

    });

}

function updateUnreadBadge(count){

    const unreadBadge = document.getElementById('unread-badge');
    const totalCount = parseInt(count) || 0;

    unreadBadge.textContent = totalCount;

    if (totalCount > 0) {
        unreadBadge.classList.remove('hidden');
    } else {
        unreadBadge.classList.add('hidden');
    }
}


function getCurrentUsername(){

    const hiddenInputField = document.getElementById('current-user-username-data');

    if(hiddenInputField && hiddenInputField.dataset.username){

        return hiddenInputField.dataset.username;
    }

    return null;
}

document.addEventListener('DOMContentLoaded', ()=>{
      
    const myUsername = getCurrentUsername(); // ë°›ì•„ì™€ì•¼í•¨
    const closexBtn = document.querySelector('.close-x-btn');
    const exitBtn = document.getElementById('exitConversation');

    if(exitBtn){
        exitBtn.addEventListener('click',()=>{
            const chatHeader = document.getElementById('chat-header');
            const partner = chatHeader ? chatHeader.dataset.partner : null;

            if(partner){
                exitConversation(partner);
            }else{
                alert('ëŒ€í™” ìƒëŒ€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        });
    }

    if(closexBtn){
        closexBtn.addEventListener('click', closeChatWidget);

    }

    if(myUsername){
        
        window.privateMessageWsClient = new PrivateMessageWebsocket(myUsername, handleReceivedMessage);

        window.privateMessageWsClient.connect();

        fetchAndRenderPartnerList();

        setupSearchHandler();

        setupWidgetToggle();

        setupMessageEvents();

    }else{

        console.warn("ì‚¬ìš©ì ì •ë³´ ì—†ìŒ. ì±„íŒ… ìœ„ì ¯ì„ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.");

    }
});

</script>

</body>
</html>
