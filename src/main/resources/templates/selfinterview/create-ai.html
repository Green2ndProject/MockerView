<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <div th:replace="~{fragments/head :: head}"></div>
    <title>ì…€í”„ ë©´ì ‘ ì—°ìŠµ - MockerView</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Pretendard", sans-serif;
        background: #f8f9fa;
        padding-top: 80px;
      }

      .navbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 70px;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 2rem;
        z-index: 1000;
      }

      .navbar-brand {
        font-size: 1.5rem;
        font-weight: 700;
        color: #667eea;
        text-decoration: none;
      }

      .navbar-menu {
        display: flex;
        gap: 2rem;
        list-style: none;
      }

      .navbar-menu a {
        color: #4b5563;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s;
      }

      .navbar-menu a:hover {
        color: #667eea;
      }

      .container-main {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 2rem;
      }

      .page-header {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid #e5e7eb;
      }

      .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: #0a0a0a;
        margin-bottom: 0.5rem;
      }

      .page-subtitle {
        color: #6b7280;
        font-size: 1rem;
      }

      .setup-card {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid #e5e7eb;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s ease-out;
      }

      .setup-card.visible {
        opacity: 1;
        transform: translateY(0);
      }

      .setup-card.hidden {
        display: none;
      }

      .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #0a0a0a;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .step-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: #667eea;
        color: white;
        border-radius: 50%;
        font-weight: 700;
        font-size: 0.875rem;
      }

      .category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
      }

      .category-card {
        background: #fafbfc;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 1.25rem;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
      }

      .category-card:hover {
        border-color: #667eea;
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
      }

      .category-card.selected {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
      }

      .category-icon {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
      }

      .category-name {
        font-weight: 600;
        color: #0a0a0a;
        margin-bottom: 0.25rem;
      }

      .category-desc {
        font-size: 0.8125rem;
        color: #6b7280;
      }

      .question-type-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
      }

      .type-card {
        background: #fafbfc;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .type-card:hover {
        border-color: #667eea;
        background: white;
        transform: translateY(-2px);
      }

      .type-card.selected {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
      }

      .type-icon {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
      }

      .type-name {
        font-weight: 600;
        color: #0a0a0a;
        margin-bottom: 0.5rem;
      }

      .type-desc {
        font-size: 0.8125rem;
        color: #6b7280;
      }

      .difficulty-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
      }

      .difficulty-card {
        background: #fafbfc;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .difficulty-card:hover {
        border-color: #667eea;
        background: white;
      }

      .difficulty-card.selected {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
      }

      .count-selector {
        display: flex;
        align-items: center;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 2rem;
      }

      .count-btn {
        width: 48px;
        height: 48px;
        border: 2px solid #d1d5db;
        border-radius: 50%;
        background: white;
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.2s;
      }

      .count-btn:hover {
        border-color: #667eea;
        color: #667eea;
      }

      .count-display {
        font-size: 3rem;
        font-weight: 700;
        color: #667eea;
        min-width: 120px;
        text-align: center;
      }

      .btn-generate {
        background: #667eea;
        color: white;
        border: none;
        padding: 1rem 3rem;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1.125rem;
        cursor: pointer;
        transition: all 0.2s;
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
        display: block;
      }

      .btn-generate:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
      }

      .btn-generate:disabled {
        background: #d1d5db;
        cursor: not-allowed;
        transform: none;
      }

      .questions-section {
        display: none;
      }

      .questions-section.active {
        display: block;
      }

      .question-card {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e5e7eb;
      }

      .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .question-number {
        background: #667eea;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
      }

      .question-text {
        font-size: 1.25rem;
        font-weight: 600;
        color: #0a0a0a;
        line-height: 1.6;
        margin-bottom: 1.5rem;
      }

      .video-container {
        width: 100%;
        max-width: 640px;
        height: 360px;
        background: #000;
        border-radius: 10px;
        margin: 0 auto 1rem;
        position: relative;
        overflow: hidden;
      }

      .video-container video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .recording-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #ef4444;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.875rem;
        animation: pulse 1.5s infinite;
      }

      .answer-input {
        width: 100%;
        min-height: 200px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 1rem;
        font-size: 1rem;
        resize: vertical;
        transition: border-color 0.2s;
        font-family: "Pretendard", sans-serif;
        margin-bottom: 1rem;
      }

      .answer-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .record-controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .btn-record {
        padding: 0.75rem;
        border-radius: 8px;
        border: 2px solid #667eea;
        background: white;
        color: #667eea;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-record:hover {
        background: #667eea;
        color: white;
      }

      .btn-record.recording {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
        animation: pulse 1.5s infinite;
      }

      .btn-record.active {
        background: #667eea;
        color: white;
      }

      .feedback-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .btn-feedback {
        padding: 0.75rem;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        color: white;
      }

      .btn-feedback.text {
        background: #10b981;
      }

      .btn-feedback.audio {
        background: #f59e0b;
      }

      .btn-feedback.video {
        background: #8b5cf6;
      }

      .btn-feedback:hover {
        transform: translateY(-2px);
        filter: brightness(1.1);
      }

      .btn-feedback:disabled {
        background: #d1d5db;
        cursor: not-allowed;
        transform: none;
      }

      .feedback-section {
        background: #fafbfc;
        border-radius: 10px;
        padding: 1.5rem;
        margin-top: 1.5rem;
        display: none;
      }

      .feedback-section.active {
        display: block;
      }

      .feedback-title {
        font-weight: 600;
        color: #0a0a0a;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .feedback-content {
        line-height: 1.8;
        color: #0a0a0a;
      }

      .score-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
      }

      .score-high {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
      }

      .score-medium {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
      }

      .score-low {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
      }

      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #e5e7eb;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      .final-report {
        background: #667eea;
        border-radius: 12px;
        padding: 3rem;
        margin-top: 3rem;
        color: white;
        display: none;
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
      }

      .final-report.active {
        display: block;
      }

      .report-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        text-align: center;
      }

      .report-subtitle {
        text-align: center;
        font-size: 1.125rem;
        margin-bottom: 3rem;
        opacity: 0.9;
      }

      .report-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 2rem;
        margin-bottom: 3rem;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .stat-value {
        font-size: 3.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }

      .stat-label {
        font-size: 0.875rem;
        opacity: 0.9;
      }

      .report-summary {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        line-height: 1.8;
      }

      .btn-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
      }

      .btn-action {
        background: white;
        color: #667eea;
        border: none;
        padding: 1rem 2rem;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(255, 255, 255, 0.3);
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        padding: 2.5rem;
        max-width: 500px;
        width: 90%;
        position: relative;
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .close-modal {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #9ca3af;
        transition: color 0.2s;
      }

      .close-modal:hover {
        color: #4b5563;
      }

      .modal-title-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .modal-icon {
        width: 56px;
        height: 56px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
      }

      .modal-title-row h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0a0a0a;
        margin: 0;
      }

      .limit-info-box {
        background: #f9fafb;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e5e7eb;
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-label {
        font-weight: 600;
        color: #4b5563;
      }

      .info-value {
        font-weight: 700;
        color: #0a0a0a;
      }

      .error-badge {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.875rem;
      }

      .error-text {
        color: #ef4444;
      }

      .modal-message {
        text-align: center;
        color: #6b7280;
        margin-bottom: 1.5rem;
        line-height: 1.6;
      }

      .features-box {
        background: rgba(102, 126, 234, 0.05);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .feature-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 0;
        color: #0a0a0a;
      }

      .check-icon {
        width: 24px;
        height: 24px;
        background: #667eea;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: 700;
      }

      .modal-actions {
        display: flex;
        gap: 1rem;
      }

      .btn-cancel {
        flex: 1;
        padding: 0.875rem;
        border: 2px solid #e5e7eb;
        background: white;
        color: #4b5563;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-cancel:hover {
        background: #f9fafb;
        border-color: #d1d5db;
      }

      .btn-upgrade {
        flex: 2;
        padding: 0.875rem;
        background: #667eea;
        color: white;
        border-radius: 10px;
        font-weight: 600;
        text-align: center;
        text-decoration: none;
        transition: all 0.2s;
        display: block;
      }

      .btn-upgrade:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 2rem;
      }

      .progress-fill {
        height: 100%;
        background: #667eea;
        transition: width 0.3s;
      }

      @media (max-width: 1024px) {
        .question-type-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .category-grid {
          grid-template-columns: repeat(3, 1fr);
        }

        .report-stats {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .category-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .question-type-grid {
          grid-template-columns: 1fr;
        }

        .difficulty-options {
          grid-template-columns: 1fr;
        }

        .record-controls {
          grid-template-columns: 1fr;
        }

        .feedback-grid {
          grid-template-columns: 1fr;
        }

        .report-stats {
          grid-template-columns: 1fr;
        }

        .btn-actions {
          flex-direction: column;
        }

        .modal-actions {
          flex-direction: column;
        }
      }
    </style>
    <div th:replace="~{fragments/styles :: styles}"></div>
  </head>
  <body>
    <div th:replace="~{fragments/navbar :: navbar}"></div>
    <!-- <nav class="navbar">
      <a href="/" class="navbar-brand">MockerView</a>
      <ul class="navbar-menu">
        <li><a href="/selfinterview/create">ë©´ì ‘ ì„¸ì…˜</a></li>
        <li><a href="/selfinterview/create-ai">ì…€í”„ ë©´ì ‘</a></li>
        <li><a href="/reviews">ë¦¬ë·°</a></li>
        <li><a href="/auth/mypage">ë§ˆì´í˜ì´ì§€</a></li>
        <li><a href="/logout">ë¡œê·¸ì•„ì›ƒ</a></li>
      </ul>
    </nav> -->

    <div class="container-main">
      <div class="page-header">
        <h1 class="page-title">ğŸ¯ ì…€í”„ ë©´ì ‘ ì—°ìŠµ</h1>
        <p class="page-subtitle">
          AIê°€ ìƒì„±í•œ ë§ì¶¤í˜• ì§ˆë¬¸ìœ¼ë¡œ í˜¼ìì„œë„ ë©´ì ‘ì„ ì¤€ë¹„í•˜ì„¸ìš”.
        </p>
      </div>

      <div id="setupSection">
        <div class="setup-card visible" id="step1">
          <h3 class="section-title">
            <span class="step-badge">1</span>
            ì§ë¬´ ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
          </h3>
          <div class="category-grid" id="mainCategoryGrid"></div>
        </div>

        <div class="setup-card hidden" id="step2">
          <h3 class="section-title">
            <span class="step-badge">2</span>
            ì„¸ë¶€ ì§ë¬´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
          </h3>
          <div class="category-grid" id="subCategoryGrid"></div>
        </div>

        <div class="setup-card hidden" id="step3">
          <h3 class="section-title">
            <span class="step-badge">3</span>
            ì§ˆë¬¸ ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”
          </h3>
          <div class="question-type-grid">
            <div class="type-card" data-type="TECHNICAL">
              <div class="type-icon">ğŸ’¡</div>
              <div class="type-name">ê¸°ìˆ  ì§ˆë¬¸</div>
              <div class="type-desc">ì „ë¬¸ ì§€ì‹ í‰ê°€</div>
            </div>
            <div class="type-card" data-type="PERSONALITY">
              <div class="type-icon">â¤ï¸</div>
              <div class="type-name">ì¸ì„± ì§ˆë¬¸</div>
              <div class="type-desc">ê°€ì¹˜ê´€ íŒŒì•…</div>
            </div>
            <div class="type-card" data-type="EXPERIENCE">
              <div class="type-icon">ğŸ“š</div>
              <div class="type-name">ê²½í—˜ ì§ˆë¬¸</div>
              <div class="type-desc">ê³¼ê±° ê²½í—˜</div>
            </div>
            <div class="type-card" data-type="SITUATION">
              <div class="type-icon">ğŸ­</div>
              <div class="type-name">ìƒí™© ì§ˆë¬¸</div>
              <div class="type-desc">ê°€ìƒ ìƒí™©</div>
            </div>
          </div>
        </div>

        <div class="setup-card hidden" id="step4">
          <h3 class="section-title">
            <span class="step-badge">4</span>
            ë‚œì´ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
          </h3>
          <div class="difficulty-options">
            <div class="difficulty-card" data-difficulty="1">
              <div class="type-icon">ğŸŒ±</div>
              <div class="type-name">ì´ˆê¸‰</div>
              <div class="type-desc">ê¸°ë³¸ ê°œë…</div>
            </div>
            <div class="difficulty-card" data-difficulty="2">
              <div class="type-icon">ğŸŒ¿</div>
              <div class="type-name">ì¤‘ê¸‰</div>
              <div class="type-desc">ì‹¤ë¬´ ê²½í—˜</div>
            </div>
            <div class="difficulty-card" data-difficulty="3">
              <div class="type-icon">ğŸŒ³</div>
              <div class="type-name">ê³ ê¸‰</div>
              <div class="type-desc">ì‹¬í™” ë¬¸ì œ</div>
            </div>
          </div>
        </div>

        <div class="setup-card hidden" id="step5">
          <h3 class="section-title">
            <span class="step-badge">5</span>
            ì§ˆë¬¸ ê°œìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
          </h3>
          <div class="count-selector">
            <button class="count-btn" id="decreaseBtn">âˆ’</button>
            <div class="count-display" id="questionCount">5</div>
            <button class="count-btn" id="increaseBtn">+</button>
          </div>
        </div>

        <div class="setup-card hidden" id="step6">
          <button class="btn-generate" id="generateBtn">
            âœ¨ ì§ˆë¬¸ ìƒì„±í•˜ê¸°
          </button>
        </div>
      </div>

      <div id="questionsSection" class="questions-section">
        <div class="setup-card visible">
          <div class="progress-bar">
            <div
              class="progress-fill"
              id="progressFill"
              style="width: 0%"
            ></div>
          </div>
          <div id="questionsContainer"></div>
        </div>

        <div class="final-report" id="finalReport">
          <h2 class="report-title">ğŸ‰ ë©´ì ‘ ì™„ë£Œ!</h2>
          <p class="report-subtitle">AI ê¸°ë°˜ ì¢…í•© í‰ê°€ ë¦¬í¬íŠ¸</p>
          <div class="report-stats" id="reportStats"></div>
          <div class="report-summary" id="reportSummary"></div>
          <div class="btn-actions">
            <button onclick="location.href='/mypage'" class="btn-action">
              ğŸ“Š ë§ˆì´í˜ì´ì§€ì—ì„œ ë³´ê¸°
            </button>
            <button onclick="location.reload()" class="btn-action">
              ğŸ”„ ìƒˆ ë©´ì ‘ ì‹œì‘
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="sessionLimitModal" class="modal">
      <div class="modal-content">
        <button class="close-modal" onclick="closeModal()">&times;</button>

        <div class="modal-title-row">
          <div class="modal-icon">ğŸ¯</div>
          <h2>ì„¸ì…˜ ìƒì„± í•œë„ ë„ë‹¬</h2>
        </div>

        <div class="limit-info-box">
          <div class="info-row">
            <span class="info-label">í˜„ì¬ í”Œëœ</span>
            <span class="error-badge" id="currentPlan">FREE</span>
          </div>
          <div class="info-row">
            <span class="info-label">ì„¸ì…˜ ìƒì„±</span>
            <span class="info-value">
              <span class="error-text" id="usedSessions">0</span> /
              <span id="sessionLimit">0</span>
            </span>
          </div>
        </div>

        <p class="modal-message">
          ë” ë§ì€ ì„¸ì…˜ì„ ìƒì„±í•˜ë ¤ë©´ í”Œëœì„ ì—…ê·¸ë ˆì´ë“œí•˜ì„¸ìš”
        </p>

        <div class="features-box">
          <div class="feature-item">
            <span class="check-icon">âœ“</span>
            <span>ë¬´ì œí•œ ì„¸ì…˜ ìƒì„±</span>
          </div>
          <div class="feature-item">
            <span class="check-icon">âœ“</span>
            <span>ë¬´ì œí•œ ë¦¬ë·° ì½ê¸°</span>
          </div>
          <div class="feature-item">
            <span class="check-icon">âœ“</span>
            <span>ê³ ê¸‰ AI í”¼ë“œë°±</span>
          </div>
        </div>

        <div class="modal-actions">
          <button onclick="closeModal()" class="btn-cancel">ì·¨ì†Œ</button>
          <a href="/payment/plans" class="btn-upgrade">í”Œëœ ì—…ê·¸ë ˆì´ë“œ â†’</a>
        </div>
      </div>
    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>
    <div th:replace="~{fragments/scripts :: scripts}"></div>

    <script>
      let selectedMainCategory = null;
      let selectedMainCategoryName = null;
      let selectedSubCategory = null;
      let selectedSubCategoryName = null;
      let selectedQuestionType = null;
      let selectedDifficulty = null;
      let questionCount = 5;
      let generatedQuestions = [];
      let currentAnswers = {};
      let videoStreams = {};
      let videoRecorders = {};
      let videoBlobs = {};
      let audioRecorders = {};
      let audioBlobs = {};
      let recordingChunks = {};
      let feedbackResults = {};
      let canCreateSession = true;

      $(document).ready(function () {
        checkSessionLimit();
        loadMainCategories();

        $("#decreaseBtn").click(function () {
          if (questionCount > 1) {
            questionCount--;
            $("#questionCount").text(questionCount);
            showGenerateButton();
          }
        });

        $("#increaseBtn").click(function () {
          if (questionCount < 20) {
            questionCount++;
            $("#questionCount").text(questionCount);
            showGenerateButton();
          }
        });

        $("#generateBtn").click(function () {
          if (!canCreateSession) {
            openModal();
            return;
          }
          generateQuestions();
        });
      });

      function checkSessionLimit() {
        $.ajax({
          url: "/api/session-limit/check",
          method: "GET",
          success: function (response) {
            canCreateSession = response.canCreate;

            if (response.limitReached) {
              console.log("ì„¸ì…˜ ì œí•œ ë„ë‹¬:", response);
              $("#currentPlan").text(response.currentPlan);
              $("#usedSessions").text(response.usedSessions);
              $("#sessionLimit").text(response.sessionLimit);
            }
          },
          error: function () {
            console.error("ì„¸ì…˜ ì œí•œ ì²´í¬ ì‹¤íŒ¨");
            canCreateSession = false;
          },
        });
      }

      function openModal() {
        $("#sessionLimitModal").addClass("active");
      }

      function closeModal() {
        $("#sessionLimitModal").removeClass("active");
      }

      $(document).on("click", ".category-card:not(.sub-category)", function () {
        $(".category-card:not(.sub-category)").removeClass("selected");
        $(this).addClass("selected");
        selectedMainCategory = $(this).data("code");
        selectedMainCategoryName = $(this).find(".category-name").text();
        loadSubCategories(selectedMainCategory);
      });

      $(document).on("click", ".sub-category", function () {
        $(".sub-category").removeClass("selected");
        $(this).addClass("selected");
        selectedSubCategory = $(this).data("code");
        selectedSubCategoryName = $(this).find(".category-name").text();
        showStep("#step3");
      });

      $(document).on("click", ".type-card", function () {
        $(".type-card").removeClass("selected");
        $(this).addClass("selected");
        selectedQuestionType = $(this).data("type");
        showStep("#step4");
      });

      $(document).on("click", ".difficulty-card", function () {
        $(".difficulty-card").removeClass("selected");
        $(this).addClass("selected");
        selectedDifficulty = $(this).data("difficulty");
        showStep("#step5");
      });

      function loadMainCategories() {
        $.ajax({
          url: "/api/questions/categories/main",
          method: "GET",
          success: function (categories) {
            displayMainCategories(categories);
          },
        });
      }

      function displayMainCategories(categories) {
        const $grid = $("#mainCategoryGrid");
        $grid.empty();
        categories.forEach((cat) => {
          $grid.append(`
                    <div class="category-card" data-code="${cat.code}">
                        <div class="category-icon">${cat.icon || "ğŸ“"}</div>
                        <div class="category-name">${cat.name}</div>
                        <div class="category-desc">${
                          cat.description || ""
                        }</div>
                    </div>
                `);
        });
      }

      function loadSubCategories(parentCode) {
        $.ajax({
          url: `/api/questions/categories/${parentCode}/sub`,
          method: "GET",
          success: function (categories) {
            displaySubCategories(categories);
            showStep("#step2");
          },
        });
      }

      function displaySubCategories(categories) {
        const $grid = $("#subCategoryGrid");
        $grid.empty();
        categories.forEach((cat) => {
          $grid.append(`
                    <div class="category-card sub-category" data-code="${
                      cat.code
                    }">
                        <div class="category-icon">${cat.icon || "ğŸ“‹"}</div>
                        <div class="category-name">${cat.name}</div>
                        <div class="category-desc">${
                          cat.description || ""
                        }</div>
                    </div>
                `);
        });
      }

      function showStep(stepId) {
        setTimeout(() => {
          $(stepId).removeClass("hidden").addClass("visible");
          $("html, body").animate(
            {
              scrollTop: $(stepId).offset().top - 100,
            },
            500
          );
        }, 300);
      }

      function showGenerateButton() {
        if (!$("#step6").hasClass("visible")) showStep("#step6");
      }

      function generateQuestions() {
        const $btn = $("#generateBtn");
        $btn
          .prop("disabled", true)
          .html('<span class="loading-spinner"></span> ì§ˆë¬¸ ìƒì„± ì¤‘...');

        $.ajax({
          url: "/api/questions/generate-multiple",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            categoryCode: selectedSubCategory,
            questionType: selectedQuestionType,
            difficulty: selectedDifficulty,
            count: questionCount,
          }),
          success: function (response) {
            generatedQuestions = response;
            displayQuestions();
            $("#setupSection").hide();
            $("#questionsSection").addClass("active");
            window.scrollTo(0, 0);
          },
          error: function (xhr) {
            if (xhr.status === 403) {
              openModal();
            } else {
              alert("ì§ˆë¬¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
            }
            $btn.prop("disabled", false).html("âœ¨ ì§ˆë¬¸ ìƒì„±í•˜ê¸°");
          },
        });
      }

      function displayQuestions() {
        const $container = $("#questionsContainer");
        $container.empty();

        generatedQuestions.forEach((question, index) => {
          $container.append(`
                    <div class="question-card">
                        <div class="question-header">
                            <div class="question-number">${index + 1}</div>
                            <span style="color: #6b7280; font-size: 0.875rem;">
                                ${selectedQuestionType} Â· ë‚œì´ë„ ${selectedDifficulty}
                            </span>
                        </div>
                        <div class="question-text">${question}</div>
                        <div class="video-container" id="video-${index}" style="display:none;">
                            <video id="local-video-${index}" autoplay muted></video>
                            <div class="recording-indicator" id="rec-indicator-${index}" style="display:none;">ğŸ”´ REC</div>
                        </div>
                        <textarea class="answer-input" id="answer-${index}"
                                  placeholder="STAR ê¸°ë²•ìœ¼ë¡œ ë‹µë³€í•´ë³´ì„¸ìš”.&#10;&#10;ğŸ“Œ S (Situation): ì–´ë–¤ ìƒí™©ì´ì—ˆë‚˜ìš”?&#10;ğŸ“Œ T (Task): ë¬´ìŠ¨ ê³¼ì œë‚˜ ëª©í‘œê°€ ìˆì—ˆë‚˜ìš”?&#10;ğŸ“Œ A (Action): ì–´ë–¤ í–‰ë™ì„ í•˜ì…¨ë‚˜ìš”?&#10;ğŸ“Œ R (Result): ì–´ë–¤ ê²°ê³¼ê°€ ë‚˜ì™”ë‚˜ìš”?"></textarea>
                        <div class="record-controls">
                            <button class="btn-record" onclick="toggleVideo(${index})" id="video-btn-${index}">ğŸ¥ í™”ìƒ ì¼œê¸°</button>
                            <button class="btn-record" onclick="toggleAudioRecording(${index})" id="audio-btn-${index}">ğŸ¤ ìŒì„± ë…¹ìŒ</button>
                        </div>
                        <div class="feedback-grid">
                            <button class="btn-feedback text" onclick="getTextFeedback(${index})" id="text-feedback-btn-${index}">
                                ğŸ“ í…ìŠ¤íŠ¸ í‰ê°€
                            </button>
                            <button class="btn-feedback audio" onclick="getAudioFeedback(${index})" disabled id="audio-feedback-btn-${index}">
                                ğŸ¤ ìŒì„± í‰ê°€
                            </button>
                            <button class="btn-feedback video" onclick="getVideoFeedback(${index})" disabled id="video-feedback-btn-${index}">
                                ğŸ“¹ ì˜ìƒ í‰ê°€
                            </button>
                        </div>
                        <div class="feedback-section" id="feedback-${index}"></div>
                    </div>
                `);

          $(`#answer-${index}`).on("input", function () {
            currentAnswers[index] = $(this).val();
          });
        });
      }

      async function toggleVideo(index) {
        const $container = $(`#video-${index}`);
        const $btn = $(`#video-btn-${index}`);
        const $indicator = $(`#rec-indicator-${index}`);

        if ($container.is(":visible")) {
          if (videoRecorders[index]) {
            videoRecorders[index].stop();
            delete videoRecorders[index];
            $indicator.hide();
          }
          if (videoStreams[index]) {
            videoStreams[index].getTracks().forEach((track) => track.stop());
            delete videoStreams[index];
          }
          $container.hide();
          $btn.html("ğŸ¥ í™”ìƒ ì¼œê¸°").removeClass("active");
        } else {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: {
                width: 640,
                height: 360,
              },
              audio: true,
            });

            videoStreams[index] = stream;
            document.getElementById(`local-video-${index}`).srcObject = stream;
            $container.show();

            const mediaRecorder = new MediaRecorder(stream);
            recordingChunks[index] = [];

            mediaRecorder.ondataavailable = (e) => {
              if (e.data.size > 0) recordingChunks[index].push(e.data);
            };

            mediaRecorder.onstop = () => {
              const blob = new Blob(recordingChunks[index], {
                type: "video/webm",
              });
              videoBlobs[index] = blob;
              $(`#video-feedback-btn-${index}`).prop("disabled", false);
              delete recordingChunks[index];
            };

            mediaRecorder.start();
            videoRecorders[index] = mediaRecorder;

            $indicator.show();
            $btn.html("ğŸ“¹ í™”ìƒ ë‹µë³€ ì™„ë£Œ").addClass("active");
          } catch (error) {
            alert("ì¹´ë©”ë¼ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
          }
        }
      }

      function toggleAudioRecording(index) {
        if (audioRecorders[index]) {
          stopAudioRecording(index);
        } else {
          startAudioRecording(index);
        }
      }

      function startAudioRecording(index) {
        navigator.mediaDevices
          .getUserMedia({
            audio: true,
          })
          .then((stream) => {
            const mediaRecorder = new MediaRecorder(stream);
            recordingChunks[index] = [];

            mediaRecorder.ondataavailable = (e) => {
              if (e.data.size > 0) recordingChunks[index].push(e.data);
            };

            mediaRecorder.onstop = () => {
              const blob = new Blob(recordingChunks[index], {
                type: "audio/webm",
              });
              if (blob.size >= 1024) {
                audioBlobs[index] = blob;
                $(`#audio-feedback-btn-${index}`).prop("disabled", false);
                transcribeAudio(blob, index);
              }
              stream.getTracks().forEach((track) => track.stop());
              delete recordingChunks[index];
            };

            mediaRecorder.start();
            audioRecorders[index] = mediaRecorder;
            $(`#audio-btn-${index}`).addClass("recording").html("â¹ï¸ ë…¹ìŒ ì¤‘ì§€");
          });
      }

      function stopAudioRecording(index) {
        if (audioRecorders[index]) {
          audioRecorders[index].stop();
          delete audioRecorders[index];
          $(`#audio-btn-${index}`)
            .removeClass("recording")
            .html("ğŸ¤ ìŒì„± ë…¹ìŒ");
        }
      }

      function transcribeAudio(blob, index) {
        const formData = new FormData();
        formData.append("audio", blob, "recording.webm");

        $.ajax({
          url: "/api/whisper/transcribe",
          method: "POST",
          data: formData,
          processData: false,
          contentType: false,
          success: function (response) {
            if (response.success && response.text) {
              const $textarea = $(`#answer-${index}`);
              const currentText = $textarea.val();
              $textarea.val(
                currentText + (currentText ? "\n\n" : "") + response.text
              );
              $textarea.trigger("input");
            }
          },
        });
      }

      function getTextFeedback(index) {
        const answer =
          currentAnswers[index] || $(`#answer-${index}`).val().trim();
        if (!answer) {
          alert("í…ìŠ¤íŠ¸ ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        const $btn = $(`#text-feedback-btn-${index}`);
        $btn
          .prop("disabled", true)
          .html('<span class="loading-spinner"></span>');

        $.ajax({
          url: "/api/feedback/structured",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            questionText: generatedQuestions[index],
            answerText: answer,
            categoryCode: selectedSubCategory,
          }),
          success: function (response) {
            feedbackResults[index] = feedbackResults[index] || {};
            feedbackResults[index].text = response;
            displayFeedback(index, response, "ğŸ“ í…ìŠ¤íŠ¸");
            $btn.prop("disabled", false).html("ğŸ“ í…ìŠ¤íŠ¸ í‰ê°€");
            checkCompletion();
          },
          error: function () {
            alert("í”¼ë“œë°± ìƒì„± ì‹¤íŒ¨");
            $btn.prop("disabled", false).html("ğŸ“ í…ìŠ¤íŠ¸ í‰ê°€");
          },
        });
      }

      function getAudioFeedback(index) {
        if (!audioBlobs[index]) {
          alert("ë¨¼ì € ìŒì„±ì„ ë…¹ìŒí•´ì£¼ì„¸ìš”.");
          return;
        }

        const $btn = $(`#audio-feedback-btn-${index}`);
        $btn
          .prop("disabled", true)
          .html('<span class="loading-spinner"></span>');

        const formData = new FormData();
        formData.append("audio", audioBlobs[index], "audio.webm");
        formData.append("questionText", generatedQuestions[index]);

        $.ajax({
          url: "/api/feedback/audio",
          method: "POST",
          data: formData,
          processData: false,
          contentType: false,
          success: function (response) {
            feedbackResults[index] = feedbackResults[index] || {};
            feedbackResults[index].audio = response;
            displayAudioFeedback(index, response);
            $btn.prop("disabled", false).html("ğŸ¤ ìŒì„± í‰ê°€");
            checkCompletion();
          },
        });
      }

      function getVideoFeedback(index) {
        if (!videoBlobs[index]) {
          alert("ë¨¼ì € ì˜ìƒì„ ë…¹í™”í•´ì£¼ì„¸ìš”.");
          return;
        }

        const $btn = $(`#video-feedback-btn-${index}`);
        $btn
          .prop("disabled", true)
          .html('<span class="loading-spinner"></span>');

        const formData = new FormData();
        formData.append("video", videoBlobs[index], "video.webm");
        formData.append("questionText", generatedQuestions[index]);

        $.ajax({
          url: "/api/feedback/video",
          method: "POST",
          data: formData,
          processData: false,
          contentType: false,
          success: function (response) {
            feedbackResults[index] = feedbackResults[index] || {};
            feedbackResults[index].video = response;
            displayVideoFeedback(index, response);
            $btn.prop("disabled", false).html("ğŸ“¹ ì˜ìƒ í‰ê°€");
            checkCompletion();
          },
        });
      }

      function displayFeedback(index, feedback, type) {
        const score = parseInt(feedback.score) || 0;
        const scoreClass =
          score >= 4 ? "score-high" : score >= 3 ? "score-medium" : "score-low";

        const html = `
                <div class="feedback-title">
                    ${type} AI í”¼ë“œë°±
                    <span class="score-badge ${scoreClass}">â­ ${score}/5</span>
                </div>
                <div class="feedback-content">
                    <p><strong>ğŸ“Š ìš”ì•½:</strong><br>${
                      feedback.summary || "-"
                    }</p>
                    <p><strong>âœ… ê°•ì :</strong><br>${
                      feedback.strengths || "-"
                    }</p>
                    <p><strong>âš ï¸ ê°œì„ ì :</strong><br>${
                      feedback.weaknesses || "-"
                    }</p>
                    <p><strong>ğŸ’¡ ê°œì„  ì œì•ˆ:</strong><br>${
                      feedback.improvements || "-"
                    }</p>
                </div>
            `;

        $(`#feedback-${index}`).html(html).addClass("active");
      }

      function displayAudioFeedback(index, feedback) {
        const score = parseInt(feedback.score) || 0;
        const scoreClass =
          score >= 4 ? "score-high" : score >= 3 ? "score-medium" : "score-low";

        const html = `
                <div class="feedback-title">
                    ğŸ¤ ìŒì„± AI í”¼ë“œë°±
                    <span class="score-badge ${scoreClass}">â­ ${score}/5</span>
                </div>
                <div class="feedback-content">
                    <p><strong>ğŸ“Š ìš”ì•½:</strong><br>${
                      feedback.summary || "-"
                    }</p>
                    <p><strong>âœ… ê°•ì :</strong><br>${
                      feedback.strengths || "-"
                    }</p>
                    <p><strong>âš ï¸ ê°œì„ ì :</strong><br>${
                      feedback.weaknesses || "-"
                    }</p>
                    <p><strong>ğŸ’¡ ê°œì„  ì œì•ˆ:</strong><br>${
                      feedback.improvements || "-"
                    }</p>
                </div>
            `;

        $(`#feedback-${index}`).html(html).addClass("active");
      }

      function displayVideoFeedback(index, feedback) {
        const score = parseInt(feedback.score) || 0;
        const scoreClass =
          score >= 4 ? "score-high" : score >= 3 ? "score-medium" : "score-low";

        const html = `
                <div class="feedback-title">
                    ğŸ“¹ ì˜ìƒ AI í”¼ë“œë°±
                    <span class="score-badge ${scoreClass}">â­ ${score}/5</span>
                </div>
                <div class="feedback-content">
                    <p><strong>ğŸ“Š ìš”ì•½:</strong><br>${
                      feedback.summary || "-"
                    }</p>
                    <p><strong>âœ… ê°•ì :</strong><br>${
                      feedback.strengths || "-"
                    }</p>
                    <p><strong>âš ï¸ ê°œì„ ì :</strong><br>${
                      feedback.weaknesses || "-"
                    }</p>
                    <p><strong>ğŸ’¡ ê°œì„  ì œì•ˆ:</strong><br>${
                      feedback.improvements || "-"
                    }</p>
                </div>
            `;

        $(`#feedback-${index}`).html(html).addClass("active");
      }

      function checkCompletion() {
        const totalQuestions = generatedQuestions.length;
        let completedCount = 0;

        for (let i = 0; i < totalQuestions; i++) {
          if (
            feedbackResults[i] &&
            (feedbackResults[i].text ||
              feedbackResults[i].audio ||
              feedbackResults[i].video)
          ) {
            completedCount++;
          }
        }

        if (completedCount >= totalQuestions) {
          setTimeout(() => {
            showFinalReport();
          }, 1000);
        }
      }

      function showFinalReport() {
        let totalText = 0,
          totalAudio = 0,
          totalVideo = 0;
        let countText = 0,
          countAudio = 0,
          countVideo = 0;

        Object.values(feedbackResults).forEach((result) => {
          if (result.text) {
            totalText += parseInt(result.text.score) || 0;
            countText++;
          }
          if (result.audio) {
            totalAudio += parseInt(result.audio.score) || 0;
            countAudio++;
          }
          if (result.video) {
            totalVideo += parseInt(result.video.score) || 0;
            countVideo++;
          }
        });

        const avgText =
          countText > 0 ? (totalText / countText).toFixed(1) : "-";
        const avgAudio =
          countAudio > 0 ? (totalAudio / countAudio).toFixed(1) : "-";
        const avgVideo =
          countVideo > 0 ? (totalVideo / countVideo).toFixed(1) : "-";

        let sum = 0,
          count = 0;
        if (countText > 0) {
          sum += parseFloat(avgText);
          count++;
        }
        if (countAudio > 0) {
          sum += parseFloat(avgAudio);
          count++;
        }
        if (countVideo > 0) {
          sum += parseFloat(avgVideo);
          count++;
        }

        const overallAvg = count > 0 ? (sum / count).toFixed(1) : "-";

        $("#reportStats").html(`
                <div class="stat-card">
                    <div class="stat-value">${overallAvg}</div>
                    <div class="stat-label">ì¢…í•© í‰ê· </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgText}</div>
                    <div class="stat-label">í…ìŠ¤íŠ¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgAudio}</div>
                    <div class="stat-label">ìŒì„±</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgVideo}</div>
                    <div class="stat-label">ì˜ìƒ</div>
                </div>
            `);

        let summary = `ì´ ${generatedQuestions.length}ê°œì˜ ì§ˆë¬¸ì— ëŒ€í•œ ë©´ì ‘ì„ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤. `;
        if (parseFloat(overallAvg) >= 4) {
          summary += "ì „ë°˜ì ìœ¼ë¡œ ë§¤ìš° ìš°ìˆ˜í•œ ë‹µë³€ì„ ë³´ì—¬ì£¼ì…¨ìŠµë‹ˆë‹¤!";
        } else if (parseFloat(overallAvg) >= 3) {
          summary += "ì „ë°˜ì ìœ¼ë¡œ ì–‘í˜¸í•œ ë‹µë³€ì´ì—ˆìŠµë‹ˆë‹¤.";
        } else {
          summary += "AI í”¼ë“œë°±ì„ ì°¸ê³ í•˜ì—¬ ë” ë§ì€ ì—°ìŠµì„ í•´ë³´ì„¸ìš”.";
        }

        $("#reportSummary").html(
          `<p style="font-size: 1.125rem; line-height: 1.8;">${summary}</p>`
        );

        saveReport(overallAvg, avgText, avgAudio, avgVideo);

        $("#finalReport").addClass("active");
        $("html, body").animate(
          {
            scrollTop: $("#finalReport").offset().top - 100,
          },
          1000
        );
      }

      function saveReport(overallAvg, avgText, avgAudio, avgVideo) {
        $.ajax({
          url: "/api/self-interview/save-report",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            categoryCode: selectedSubCategory,
            categoryName: selectedSubCategoryName,
            questionType: selectedQuestionType,
            difficulty: selectedDifficulty,
            totalQuestions: generatedQuestions.length,
            overallAvg: overallAvg,
            textAvg: avgText,
            audioAvg: avgAudio,
            videoAvg: avgVideo,
            questions: generatedQuestions,
            feedbacks: feedbackResults,
          }),
          success: function (response) {
            console.log("ë¦¬í¬íŠ¸ ì €ì¥ ì™„ë£Œ:", response.reportId);
          },
          error: function () {
            console.error("ë¦¬í¬íŠ¸ ì €ì¥ ì‹¤íŒ¨");
          },
        });
      }
    </script>
  </body>
</html>
