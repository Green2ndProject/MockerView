<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ì…€í”„ ë©´ì ‘</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/selfinterview.css">
    <style>
        @media (max-width: 768px) {
            .selfinterview-layout { 
                display: flex; 
                flex-direction: column; 
            }
            .main-content { width: 100%; }
            .feedback-panel { 
                width: 100%; 
                margin-top: 16px; 
            }
            .progress-bar-container { padding: 12px; }
            .card-header h4 { font-size: 16px; }
            .answer-mode-toggle { 
                flex-direction: column; 
                gap: 8px; 
            }
            .answer-mode-toggle .btn { width: 100%; }
            .answer-actions { 
                flex-direction: column; 
                gap: 8px; 
            }
            .answer-actions .btn { width: 100%; }
            #videoPreview { 
                width: 100%; 
                height: auto; 
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a class="navbar-brand" href="/session/list">Mockerview</a>
                <div class="navbar-nav">
                    <a class="nav-link" href="/selfinterview/list">ë‚´ ì—°ìŠµ ê¸°ë¡</a>
                    <a class="nav-link" href="/session/list">ì„¸ì…˜ ëª©ë¡</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="session-info-bar">
        <div class="container">
            <div class="session-title-section">
                <h1 id="session-title">ì…€í”„ ë©´ì ‘</h1>
                <div class="session-meta">
                    <span class="timer">
                        <span id="session-timer">00:00</span>
                    </span>
                    <span class="badge badge-ai">AI ë©´ì ‘ê´€</span>
                    <span id="session-stats">ì§ˆë¬¸ ë¡œë”©ì¤‘...</span>
                </div>
            </div>
            <div class="session-actions">
                <button onclick="toggleResultView()" class="btn btn-secondary btn-sm">ê²°ê³¼ ë³´ê¸°</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="selfinterview-layout">
            <main class="main-content">
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text">
                        <span id="progress-current">0</span> / <span id="progress-total">0</span> ì§ˆë¬¸ ì™„ë£Œ
                    </div>
                </div>

                <div class="card current-question">
                    <div class="card-header">
                        <div class="question-info">
                            <span id="question-number">Q1</span>
                            <span class="ai-badge">AI ì§ˆë¬¸</span>
                        </div>
                        <div id="question-timer" class="question-timer">00:00</div>
                    </div>
                    <div class="card-body">
                        <div id="current-question" class="question-display">
                            <p id="current-question-text">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                    </div>
                </div>

                <div class="card answer-card" id="answer-section">
                    <div class="card-header">
                        <h4>ë‹µë³€ ì‘ì„±</h4>
                        <span class="answer-tip">ìì‹ ìˆê²Œ ë‹µë³€í•´ë³´ì„¸ìš”</span>
                    </div>
                    <div class="card-body">
                        <div class="answer-mode-toggle" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <button id="textModeBtn" class="btn btn-secondary active" onclick="switchToTextMode()">í…ìŠ¤íŠ¸ ë‹µë³€</button>
                            <button id="voiceModeBtn" class="btn btn-secondary" onclick="switchToVoiceMode()">ìŒì„± ë‹µë³€</button>
                            <button id="videoModeBtn" class="btn btn-secondary" onclick="switchToVideoMode()">í™”ìƒ ë‹µë³€</button>
                        </div>

                        <div id="text-answer-area">
                            <div class="form-group">
                                <textarea id="answerText" placeholder="ì—¬ê¸°ì— ë‹µë³€ì„ ì‘ì„±í•˜ì„¸ìš”..." class="form-control" rows="6"></textarea>
                                <div class="char-counter">
                                    <span id="charCount">0</span>/1000ì
                                </div>
                            </div>
                        </div>

                        <div id="voice-answer-area" style="display: none; text-align: center; padding: 2rem;">
                            <button id="recordBtn" class="btn btn-danger" onclick="toggleRecording()" style="width: 100px; height: 100px; border-radius: 50%; font-size: 2rem;">
                                ğŸ¤
                            </button>
                            <div id="recordingStatus" style="margin-top: 1rem; color: #6c757d; font-weight: 500;">ë…¹ìŒ ì‹œì‘í•˜ë ¤ë©´ í´ë¦­</div>
                        </div>

                        <div id="video-answer-area" style="display: none; text-align: center; padding: 2rem;">
                            <video id="videoPreview" width="400" height="300" style="border: 1px solid #ccc; margin-bottom: 1rem; border-radius: 8px;" muted></video>
                            <br>
                            <button id="videoRecordBtn" class="btn btn-danger" onclick="toggleVideoRecording()" style="width: 120px; height: 50px; border-radius: 8px; margin-bottom: 1rem;">
                                ğŸ¥ ë…¹í™” ì‹œì‘
                            </button>
                            <div id="videoRecordingStatus" style="margin-top: 1rem; color: #6c757d; font-weight: 500;">ì¹´ë©”ë¼ë¥¼ í—ˆìš©í•˜ê³  ë…¹í™” ì‹œì‘</div>
                        </div>

                        <div class="answer-actions" style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button onclick="skipQuestion()" class="btn btn-secondary">ê±´ë„ˆë›°ê¸°</button>
                            <button onclick="submitAnswer()" class="btn btn-success" style="flex: 1;">ë‹µë³€ ì œì¶œ</button>
                        </div>
                    </div>
                </div>

                <div id="result-section" class="card" style="display: none;">
                    <div class="card-header">
                        <h4>ë©´ì ‘ ì™„ë£Œ</h4>
                        <span class="badge badge-success">ë¶„ì„ ì™„ë£Œ</span>
                    </div>
                    <div class="card-body">
                        <div class="result-summary">
                            <div class="result-item">
                                <div class="result-label">í‰ê·  ì ìˆ˜</div>
                                <div id="avg-score" class="result-value">0ì </div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">ë‹µë³€í•œ ì§ˆë¬¸</div>
                                <div id="answered-count" class="result-value">0ê°œ</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">ì†Œìš” ì‹œê°„</div>
                                <div id="total-time" class="result-value">0ë¶„</div>
                            </div>
                        </div>
                        <div class="result-actions">
                            <button onclick="viewDetailedResults()" class="btn btn-primary">ìƒì„¸ ê²°ê³¼ ë³´ê¸°</button>
                            <a href="/selfinterview/create" class="btn btn-secondary">ìƒˆ ë©´ì ‘ ì‹œì‘</a>
                        </div>
                    </div>
                </div>
            </main>

            <aside class="feedback-panel">
                <div class="card">
                    <div class="card-header">
                        <h4>AI í”¼ë“œë°±</h4>
                        <span id="ai-status" class="ai-status">ëŒ€ê¸°ì¤‘</span>
                    </div>
                    <div class="card-body">
                        <div id="ai-feedback-list" class="feedback-list scrollable">
                            <div class="empty-state">
                                <div class="ai-icon">ğŸ¤–</div>
                                <p>ë‹µë³€ì´ ì œì¶œë˜ë©´ AIê°€ ì¦‰ì‹œ ë¶„ì„í•©ë‹ˆë‹¤</p>
                                <div class="ai-features">
                                    <span>â€¢ ë£¨ë¸Œë¦­ ê¸°ë°˜ í‰ê°€</span>
                                    <span>â€¢ ê°•ì  ë¶„ì„</span>
                                    <span>â€¢ ê°œì„ ì  ì œì‹œ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card question-list-card">
                    <div class="card-header">
                        <h4>ì§ˆë¬¸ ëª©ë¡</h4>
                    </div>
                    <div class="card-body">
                        <ul id="question-list" class="question-nav-list">
                        </ul>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script src="/js/authFetch.js"></script>
    <script src="/js/selfinterview-room.js"></script>
    <script>
        let isRecording = false;
        let currentMode = 'text';
        let mediaRecorder = null;
        let audioBlob = null;
        let audioChunks = [];
        let videoStream = null;
        let videoRecorder = null;
        let videoBlob = null;
        let isVideoRecording = false;

        const answerTextArea = document.getElementById('answerText');
        if (answerTextArea) {
            answerTextArea.addEventListener('input', function() {
                const count = this.value.length;
                document.getElementById('charCount').textContent = count;
                if (count > 1000) {
                    this.value = this.value.substring(0, 1000);
                    document.getElementById('charCount').textContent = 1000;
                }
            });
        }

        function switchToTextMode() {
            currentMode = 'text';
            document.getElementById('textModeBtn').classList.add('active');
            document.getElementById('voiceModeBtn').classList.remove('active');
            document.getElementById('videoModeBtn').classList.remove('active');
            document.getElementById('text-answer-area').style.display = 'block';
            document.getElementById('voice-answer-area').style.display = 'none';
            document.getElementById('video-answer-area').style.display = 'none';
        }

        function switchToVoiceMode() {
            currentMode = 'voice';
            document.getElementById('voiceModeBtn').classList.add('active');
            document.getElementById('textModeBtn').classList.remove('active');
            document.getElementById('videoModeBtn').classList.remove('active');
            document.getElementById('text-answer-area').style.display = 'none';
            document.getElementById('voice-answer-area').style.display = 'block';
            document.getElementById('video-answer-area').style.display = 'none';
        }

        function switchToVideoMode() {
            currentMode = 'video';
            document.getElementById('videoModeBtn').classList.add('active');
            document.getElementById('textModeBtn').classList.remove('active');
            document.getElementById('voiceModeBtn').classList.remove('active');
            document.getElementById('text-answer-area').style.display = 'none';
            document.getElementById('voice-answer-area').style.display = 'none';
            document.getElementById('video-answer-area').style.display = 'block';
            startVideoPreview();
        }

        async function startVideoPreview() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                document.getElementById('videoPreview').srcObject = videoStream;
                document.getElementById('videoPreview').play();
            } catch (error) {
                alert('ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', error);
            }
        }

        async function toggleVideoRecording() {
            const recordBtn = document.getElementById('videoRecordBtn');
            const recordingStatus = document.getElementById('videoRecordingStatus');

            if (!isVideoRecording) {
                try {
                    if (!videoStream) {
                        await startVideoPreview();
                    }
                    
                    videoRecorder = new MediaRecorder(videoStream);
                    let videoChunks = [];
                    
                    videoRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) {
                            videoChunks.push(e.data);
                        }
                    };
                    
                    videoRecorder.onstop = () => {
                        videoBlob = new Blob(videoChunks, { type: 'video/webm' });
                        recordingStatus.textContent = 'ë…¹í™” ì™„ë£Œ! ì œì¶œí•´ì£¼ì„¸ìš”';
                    };
                    
                    videoRecorder.start();
                    isVideoRecording = true;
                    recordBtn.innerHTML = 'â¹ï¸ ë…¹í™” ì¤‘ì§€';
                    recordBtn.style.background = '#dc3545';
                    recordingStatus.textContent = 'ë¹„ë””ì˜¤ ë…¹í™” ì¤‘...';
                } catch (error) {
                    alert('ë¹„ë””ì˜¤ ë…¹í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    console.error('ë¹„ë””ì˜¤ ë…¹í™” ì‹¤íŒ¨:', error);
                }
            } else {
                videoRecorder.stop();
                isVideoRecording = false;
                recordBtn.innerHTML = 'ğŸ¥ ë…¹í™” ì‹œì‘';
                recordBtn.style.background = '';
            }
        }

        async function toggleRecording() {
            const recordBtn = document.getElementById('recordBtn');
            const recordingStatus = document.getElementById('recordingStatus');

            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) {
                            audioChunks.push(e.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        recordingStatus.textContent = 'ë…¹ìŒ ì™„ë£Œ! ì œì¶œí•´ì£¼ì„¸ìš”';
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    recordBtn.innerHTML = 'â¹ï¸';
                    recordBtn.style.background = '#dc3545';
                    recordingStatus.textContent = 'ë…¹ìŒ ì¤‘...';
                } catch (error) {
                    alert('ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                    console.error('ë…¹ìŒ ì‹œì‘ ì‹¤íŒ¨:', error);
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.innerHTML = 'ğŸ¤';
                recordBtn.style.background = '';
            }
        }

        async function submitAnswer() {
            if (currentMode === 'text') {
                const answerText = document.getElementById('answerText').value.trim();
                if (!answerText) {
                    alert('ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”');
                    return;
                }
                if (typeof window.submitTextAnswer === 'function') {
                    window.submitTextAnswer();
                }
            } else if (currentMode === 'voice') {
                if (!audioBlob) {
                    alert('ë¨¼ì € ìŒì„±ì„ ë…¹ìŒí•´ì£¼ì„¸ìš”');
                    return;
                }
                if (typeof window.submitVoiceAnswerSelf === 'function') {
                    window.submitVoiceAnswerSelf(audioBlob);
                }
            } else if (currentMode === 'video') {
                if (!videoBlob) {
                    alert('ë¨¼ì € ë¹„ë””ì˜¤ë¥¼ ë…¹í™”í•´ì£¼ì„¸ìš”');
                    return;
                }
                await submitVideoAnswer();
            }
        }

        async function submitVideoAnswer() {
            if (!SESSION_DATA || !SESSION_DATA.sessionId) {
                alert('ì„¸ì…˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const question = questions[currentQuestionIndex];
            const formData = new FormData();
            
            formData.append('audio', videoBlob, 'answer.webm');
            formData.append('questionId', question.id);

            try {
                document.getElementById('ai-status').textContent = 'ë¹„ë””ì˜¤ ë¶„ì„ ì¤‘...';
                document.getElementById('ai-status').style.color = '#f59e0b';
                
                const token = document.cookie.split(';').find(c => c.trim().startsWith('Authorization='));
                const authToken = token ? token.split('=')[1] : '';
                
                const response = await fetch('/api/selfinterview/' + SESSION_DATA.sessionId + '/video-answer', {
                    method: 'POST',
                    headers: {
                        'Authorization': authToken
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('ë¹„ë””ì˜¤ ì œì¶œ ì‹¤íŒ¨: ' + response.status);
                }
                
                const result = await response.json();
                
                answers.push(result.answer);
                feedbacks.push(result.feedback);
                
                displayFeedback(result.feedback, question, currentQuestionIndex + 1);
                
                document.getElementById('ai-status').textContent = 'ì™„ë£Œ';
                document.getElementById('ai-status').style.color = '#10b981';
                
                videoBlob = null;
                document.getElementById('videoRecordingStatus').textContent = 'ì¹´ë©”ë¼ë¥¼ í—ˆìš©í•˜ê³  ë…¹í™” ì‹œì‘';
                
                updateProgress();
                
                setTimeout(() => {
                    loadQuestion(currentQuestionIndex + 1);
                }, 1500);
                
            } catch (error) {
                console.error('ë¹„ë””ì˜¤ ë‹µë³€ ì œì¶œ ì‹¤íŒ¨:', error);
                alert('ë¹„ë””ì˜¤ ë‹µë³€ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                document.getElementById('ai-status').textContent = 'ì‹¤íŒ¨';
                document.getElementById('ai-status').style.color = '#ef4444';
            }
        }
    </script>
</body>
</html>