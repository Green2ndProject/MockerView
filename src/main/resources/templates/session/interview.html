<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <div th:replace="~{fragments/head :: head}"></div>
    <title>ë©´ì ‘ ì§„í–‰</title>
    <div th:replace="~{fragments/styles :: styles}"></div>
    <script>
      if (
        location.protocol !== "https:" &&
        !location.hostname.includes("localhost")
      ) {
        location.replace(
          "https:" +
            window.location.href.substring(window.location.protocol.length)
        );
      }
    </script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.0.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f8f9fa;
        color: #1a1a1a;
        height: 100vh;
        overflow: hidden;
      }

      .container {
        display: grid;
        grid-template-rows: 60px 1fr;
        height: 100vh;
      }

      .header {
        background: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 24px;
        border-bottom: 1px solid #e5e7eb;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      .logo {
        font-size: 1.25rem;
        font-weight: 700;
        color: #667eea;
      }

      .timer {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1a1a1a;
      }

      .btn-end {
        padding: 10px 24px;
        background: white;
        color: #ef4444;
        border: 2px solid #ef4444;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-end:hover {
        background: #ef4444;
        color: white;
      }

      .main-content {
        display: grid;
        grid-template-columns: 280px 1fr 350px;
        gap: 16px;
        padding: 16px;
        height: calc(100vh - 60px);
        overflow: hidden;
      }

      .left-sidebar {
        display: flex;
        flex-direction: column;
        gap: 12px;
        overflow-y: auto;
      }

      .video-section {
        background: white;
        border-radius: 8px;
        padding: 12px;
        border: 1px solid #e5e7eb;
      }

      .section-title {
        font-size: 0.75rem;
        font-weight: 700;
        color: #6b7280;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .video-grid {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      /*ë¹„ë””ì˜¤ ê·¸ë¦¬ê³  hover ê°ì§€ CSS*/
      .video-student:hover {
        border: 2px solid #667eea;
        border-radius: 6px;
      }

      .video-wrapper {
        position: relative;
        background: #000;
        border-radius: 6px;
        overflow: hidden;
        aspect-ratio: 4/3;
      }

      .video-wrapper video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .video-label {
        position: absolute;
        bottom: 8px;
        left: 8px;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 700;
        backdrop-filter: blur(4px);
        border: 2px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        z-index: 10;
      }

      .interviewer-badge {
        background: #667eea;
        color: white;
        border-color: rgba(255, 255, 255, 0.3);
      }

      .center-panel {
        display: flex;
        flex-direction: column;
        gap: 12px;
        overflow-y: auto;
      }

      .qa-container {
        background: white;
        border-radius: 8px;
        padding: 16px;
        border: 1px solid #e5e7eb;
      }

      .qa-item {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #f3f4f6;
      }

      .qa-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .qa-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
      }

      .qa-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 700;
      }

      .question-badge {
        background: #dbeafe;
        color: #1e40af;
      }

      .answer-badge {
        background: #dcfce7;
        color: #166534;
      }

      .qa-author {
        font-size: 0.75rem;
        color: #6b7280;
        font-weight: 600;
      }

      .qa-content {
        font-size: 0.9375rem;
        color: #1a1a1a;
        line-height: 1.6;
      }

      .qa-time {
        font-size: 0.6875rem;
        color: #9ca3af;
        margin-top: 4px;
      }

      .right-panel {
        display: flex;
        flex-direction: column;
        gap: 12px;
        overflow-y: auto;
      }

      .control-panel {
        background: white;
        border-radius: 8px;
        padding: 16px;
        border: 1px solid #e5e7eb;
      }

      .panel-title {
        font-size: 0.875rem;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 12px;
      }

      .btn-action {
        width: 100%;
        padding: 12px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 8px;
      }

      .btn-action:hover {
        background: #5568d3;
      }

      .btn-action:last-child {
        margin-bottom: 0;
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #1a1a1a;
      }

      .btn-secondary:hover {
        background: #e5e7eb;
      }

      .btn-voice {
        background: #10b981;
      }

      .btn-voice:hover {
        background: #059669;
      }

      .btn-voice.recording {
        background: #ef4444;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .form-group {
        margin-bottom: 12px;
      }

      .form-group:last-child {
        margin-bottom: 0;
      }

      .form-label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .form-textarea {
        width: 100%;
        min-height: 80px;
        padding: 10px;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        font-size: 0.875rem;
        resize: vertical;
        font-family: inherit;
      }

      .form-textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .form-select {
        width: 100%;
        padding: 10px;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        font-size: 0.875rem;
        background: white;
      }

      .form-select:focus {
        outline: none;
        border-color: #667eea;
      }

      .star {
        cursor: pointer;
        color: #e5e7eb;
        transition: color 0.2s;
        user-select: none;
      }

      .star:hover,
      .star.active {
        color: #fbbf24;
      }

      .subtitle-section {
        background: #f9fafb;
        border-radius: 8px;
        padding: 12px;
        min-height: 80px;
        max-height: 120px;
        overflow-y: auto;
        font-size: 0.875rem;
        color: #4b5563;
        line-height: 1.6;
        position: relative;
      }

      .subtitle-content {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .subtitle-text {
        color: #1a1a1a;
        font-weight: 500;
      }

      .subtitle-interim {
        color: #9ca3af;
        font-style: italic;
      }

      ::-webkit-scrollbar {
        width: 6px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      ::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }

      @media (max-width: 1280px) {
        .main-content {
          grid-template-columns: 240px 1fr 320px;
          gap: 12px;
          padding: 12px;
        }

        .logo {
          font-size: 1.125rem;
        }

        .timer {
          font-size: 1.25rem;
        }
      }

      @media (max-width: 1024px) {
        .main-content {
          grid-template-columns: 1fr;
          grid-template-rows: auto auto auto;
          gap: 12px;
        }

        .left-sidebar {
          order: 1;
          max-height: 300px;
        }

        .center-panel {
          order: 2;
          max-height: 400px;
        }

        .right-panel {
          order: 3;
          max-height: 400px;
        }

        .video-grid {
          flex-direction: row;
          flex-wrap: wrap;
        }

        .video-wrapper {
          flex: 1;
          min-width: 200px;
        }
      }

      @media (max-width: 768px) {
        .header {
          padding: 0 16px;
          flex-wrap: wrap;
          gap: 8px;
        }

        .logo {
          font-size: 1rem;
        }

        .timer {
          font-size: 1.125rem;
        }

        .btn-end {
          padding: 8px 16px;
          font-size: 0.8125rem;
        }

        .main-content {
          padding: 8px;
          gap: 8px;
        }

        .qa-container,
        .video-section,
        .control-panel,
        .subtitle-display {
          padding: 12px;
        }

        .section-title {
          font-size: 0.6875rem;
        }

        .panel-title {
          font-size: 0.8125rem;
        }

        .qa-content {
          font-size: 0.875rem;
        }

        .btn-action {
          padding: 10px;
          font-size: 0.8125rem;
        }

        .input-field {
          padding: 10px;
          font-size: 0.8125rem;
          min-height: 60px;
        }
      }

      @media (max-width: 480px) {
        .header {
          grid-template-columns: 1fr;
          height: auto;
          padding: 12px;
        }

        .timer {
          order: -1;
          width: 100%;
          text-align: center;
          font-size: 1rem;
        }

        .logo {
          font-size: 0.9375rem;
        }

        .btn-end {
          width: 100%;
          margin-top: 8px;
        }

        .container {
          grid-template-rows: auto 1fr;
        }

        .main-content {
          height: calc(100vh - 100px);
        }

        .video-grid {
          flex-direction: column;
        }

        .video-wrapper {
          min-width: 100%;
        }

        .left-sidebar,
        .center-panel,
        .right-panel {
          max-height: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="logo">MockerView</div>
        <div class="timer" id="timer">00:00:00</div>
        <button class="btn-end" onclick="endInterview()">ë©´ì ‘ ì¢…ë£Œ</button>
      </div>

      <div class="main-content">
        <div class="left-sidebar">
          <div class="video-section">
            <div class="section-title">ë©´ì ‘ê´€</div>
            <div
              class="video-grid video-interviewer"
              id="interviewerVideos"
            ></div>
          </div>

          <div class="video-section">
            <div class="section-title">ë©´ì ‘ì</div>
            <div class="video-grid video-student" id="intervieweeVideos"></div>
          </div>

          <div class="subtitle-section">
            <div class="subtitle-content" id="subtitleContent">
              <span style="color: #9ca3af">ìë§‰ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</span>
            </div>
          </div>
        </div>

        <div class="center-panel">
          <div class="qa-container" id="qaContainer">
            <p style="text-align: center; color: #9ca3af; font-size: 0.875rem">
              ì§ˆë¬¸ê³¼ ë‹µë³€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
            </p>
          </div>
        </div>

        <div class="right-panel">
          <div
            class="control-panel"
            th:if="${participantRole.name() == 'HOST' or participantRole.name() == 'REVIEWER'}"
          >
            <div class="panel-title">ğŸ“ ë©´ì ‘ê´€ ì»¨íŠ¸ë¡¤</div>
            <button
              class="btn-action btn-voice"
              id="voiceQuestionBtn"
              onclick="toggleVoiceQuestion()"
            >
              ğŸ¤ ìŒì„±ìœ¼ë¡œ ì§ˆë¬¸í•˜ê¸°
            </button>
          </div>

          <div
            class="control-panel"
            th:if="${participantRole.name() == 'STUDENT'}"
          >
            <div class="panel-title">ğŸ’¬ ë‹µë³€ ì‘ì„±</div>
            <button
              class="btn-action btn-voice"
              id="voiceAnswerBtn"
              onclick="toggleVoiceAnswer()"
            >
              ğŸ¤ ìŒì„±ìœ¼ë¡œ ë‹µë³€í•˜ê¸°
            </button>
          </div>

          <div
            class="control-panel"
            th:if="${participantRole.name() == 'HOST' or participantRole.name() == 'REVIEWER'}"
          >
            <div
              class="panel-title"
              onclick="toggleEvaluationPanel()"
              style="
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <span>ğŸ“Š ë©´ì ‘ì í‰ê°€</span>
              <span id="evalToggleIcon" style="transition: transform 0.3s"
                >â–¼</span
              >
            </div>
            <div id="evaluationPanel" style="display: none; margin-top: 12px">
              <div class="form-group">
                <label class="form-label">ë©´ì ‘ì ì„ íƒ</label>
                <select
                  id="intervieweeSelect"
                  class="form-select"
                  onchange="loadIntervieweeData()"
                >
                  <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                </select>
              </div>

              <div
                id="aiFeedbackSection"
                style="
                  display: none;
                  margin-bottom: 16px;
                  padding: 12px;
                  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
                  border-radius: 8px;
                  border-left: 4px solid #0ea5e9;
                "
              >
                <div
                  style="
                    font-weight: 600;
                    margin-bottom: 12px;
                    color: #0369a1;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                  "
                >
                  <span>ğŸ¤–</span>
                  <span>AI í”¼ë“œë°± (ì°¸ê³ ìš©)</span>
                </div>
                <div
                  id="aiFeedbackContent"
                  style="font-size: 13px; color: #334155; line-height: 1.6"
                >
                  <div id="aiStrengths" style="margin-bottom: 8px"></div>
                  <div id="aiWeaknesses" style="margin-bottom: 8px"></div>
                  <div id="aiImprovements"></div>
                </div>
                <button
                  onclick="copyAIToForm()"
                  style="
                    margin-top: 10px;
                    padding: 6px 12px;
                    background: #0ea5e9;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                  "
                >
                  ğŸ“‹ AI í”¼ë“œë°± ë³µì‚¬í•˜ê¸°
                </button>
              </div>

              <div class="form-group">
                <label class="form-label">í‰ê°€ ì ìˆ˜</label>
                <div style="display: flex; gap: 8px; font-size: 1.5rem">
                  <span class="star" data-rating="1" onclick="setRating(1)"
                    >â˜…</span
                  >
                  <span class="star" data-rating="2" onclick="setRating(2)"
                    >â˜…</span
                  >
                  <span class="star" data-rating="3" onclick="setRating(3)"
                    >â˜…</span
                  >
                  <span class="star" data-rating="4" onclick="setRating(4)"
                    >â˜…</span
                  >
                  <span class="star" data-rating="5" onclick="setRating(5)"
                    >â˜…</span
                  >
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">ê°•ì  (ë©´ì ‘ê´€ ì˜ê²¬)</label>
                <textarea
                  id="strengths"
                  class="form-textarea"
                  placeholder="AI í”¼ë“œë°±ì„ ì°¸ê³ í•˜ì—¬ ë©´ì ‘ìì˜ ê°•ì ì„ ì…ë ¥í•˜ì„¸ìš”"
                ></textarea>
              </div>

              <div class="form-group">
                <label class="form-label">ì•½ì  (ë©´ì ‘ê´€ ì˜ê²¬)</label>
                <textarea
                  id="weaknesses"
                  class="form-textarea"
                  placeholder="AI í”¼ë“œë°±ì„ ì°¸ê³ í•˜ì—¬ ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ì„ ì…ë ¥í•˜ì„¸ìš”"
                ></textarea>
              </div>

              <div class="form-group">
                <label class="form-label">ê°œì„  ì‚¬í•­ (ë©´ì ‘ê´€ ì˜ê²¬)</label>
                <textarea
                  id="improvements"
                  class="form-textarea"
                  placeholder="AI í”¼ë“œë°±ì„ ì°¸ê³ í•˜ì—¬ êµ¬ì²´ì ì¸ ê°œì„  ë°©ë²•ì„ ì…ë ¥í•˜ì„¸ìš”"
                ></textarea>
              </div>

              <div class="form-group">
                <label class="form-label">ì¢…í•© ì˜ê²¬ (ë©´ì ‘ê´€ ìµœì¢… í‰ê°€)</label>
                <textarea
                  id="notes"
                  class="form-textarea"
                  placeholder="ë©´ì ‘ì— ëŒ€í•œ ì¢…í•©ì ì¸ í‰ê°€ ì˜ê²¬ì„ ì…ë ¥í•˜ì„¸ìš”"
                ></textarea>
              </div>

              <div
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px"
              >
                <button
                  class="btn-action btn-secondary"
                  onclick="saveEvaluation()"
                >
                  ì„ì‹œì €ì¥
                </button>
                <button class="btn-action" onclick="submitEvaluation()">
                  ì œì¶œí•˜ê¸°
                </button>
              </div>
            </div>
          </div>

          <div class="control-panel">
            <div
              class="panel-title"
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <span>ğŸ¤– AI í”¼ë“œë°±</span>
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 6px;
                  font-size: 0.75rem;
                  cursor: pointer;
                  margin: 0;
                "
              >
                <input
                  type="checkbox"
                  id="aiToggle"
                  checked
                  onchange="toggleAI()"
                  style="cursor: pointer; width: 16px; height: 16px"
                />
                <span id="aiToggleLabel">ON</span>
              </label>
            </div>
            <div id="aiPanel">
              <div
                id="aiFeedback"
                style="
                  font-size: 0.8125rem;
                  color: #4b5563;
                  line-height: 1.6;
                  padding: 12px;
                  background: #f9fafb;
                  border-radius: 6px;
                  min-height: 100px;
                  margin-top: 12px;
                "
              >
                AI í”¼ë“œë°±ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
              </div>
              <button
                class="btn-action"
                style="margin-top: 8px"
                onclick="requestAIFeedback()"
              >
                AI í”¼ë“œë°± ìš”ì²­
              </button>
            </div>
          </div>

          <div class="control-panel">
            <div class="panel-title">ğŸ¬ ë…¹í™”</div>
            <button
              id="startRecordBtn"
              class="btn-action"
              onclick="startRecording()"
            >
              ğŸ¬ ë…¹í™” ì‹œì‘
            </button>
            <button
              id="stopRecordBtn"
              class="btn-action"
              onclick="stopRecording()"
              style="display: none; background: #ef4444"
            >
              â¹ï¸ ë…¹í™” ì¤‘ì§€
            </button>
            <div
              id="recordingIndicator"
              style="
                display: none;
                color: #ef4444;
                font-weight: 600;
                text-align: center;
                margin-top: 8px;
                font-size: 0.75rem;
              "
            >
              ğŸ”´ ë…¹í™” ì¤‘...
            </div>
            <div id="uploadProgress" style="display: none; margin-top: 8px">
              <div
                style="
                  background: #f3f4f6;
                  border-radius: 4px;
                  overflow: hidden;
                  height: 4px;
                "
              >
                <div
                  id="uploadProgressBar"
                  style="
                    width: 0%;
                    height: 100%;
                    background: #667eea;
                    transition: width 0.3s;
                  "
                ></div>
              </div>
              <small
                id="uploadStatus"
                style="
                  color: #6b7280;
                  font-size: 0.75rem;
                  margin-top: 4px;
                  display: block;
                "
              ></small>
            </div>
          </div>

          <div class="control-panel">
            <div class="panel-title">âš™ï¸ ì„¤ì •</div>
            <button class="btn-action btn-secondary" onclick="toggleMic()">
              ğŸ¤ ë§ˆì´í¬
            </button>
            <button class="btn-action btn-secondary" onclick="toggleCamera()">
              ğŸ“¹ ì¹´ë©”ë¼
            </button>
          </div>
        </div>
      </div>
    </div>
    <div th:replace="~{fragments/chat-widget :: messageWidget}"></div>
    <button th:replace="~{fragments/chat-widget :: messageWidgetBtn}"></button>
    <div th:replace="~{fragments/chat-widget :: toast}"></div>
    <div th:replace="~{fragments/footer :: footer}"></div>
    <div th:replace="~{fragments/scripts :: scripts}"></div>

    <script th:inline="javascript">
      const sessionId = /*[[${sessionId}]]*/ null;
      const currentUserId = /*[[${currentUser.id}]]*/ null;
      const currentUserName = /*[[${currentUser.name}]]*/ "User";
      const currentUserRole = /*[[${participantRole.name()}]]*/ "STUDENT";
      const agoraAppId = /*[[${agoraToken.appId}]]*/ null;
      const agoraChannel = /*[[${agoraToken.channel}]]*/ null;
      const agoraToken = /*[[${agoraToken.token}]]*/ null;

      console.log("=== Interview Page Loaded ===");
      console.log("Session ID:", sessionId);
      console.log("Current User ID:", currentUserId);
      console.log("User Role:", currentUserRole);
      console.log("Protocol:", location.protocol);
      console.log("Hostname:", location.hostname);

      let agoraClient = null;
      let localAudioTrack = null;
      let localVideoTrack = null;
      let qaList = [];
      let questionCount = 0;
      let answerCount = 0;
      let currentRating = 0;
      let evaluations = {};
      let stompClient = null;
      let participantRoles = {};
      let participantNames = {};

      let recognition = null;
      let isRecordingQuestion = false;
      let isRecordingAnswer = false;
      let finalTranscript = "";
      let interimTranscript = "";

      let mediaRecorder = null;
      let recordedChunks = [];
      let isRecording = false;
      let recordingStream = null;

      async function init() {
        console.log("=== ì´ˆê¸°í™” ì‹œì‘ ===");

        if (
          location.protocol === "http:" &&
          !location.hostname.includes("localhost")
        ) {
          console.warn("âš ï¸ HTTP í™˜ê²½ ê°ì§€! ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        }

        await joinSession();
        await new Promise((resolve) => setTimeout(resolve, 500));
        await loadParticipantRoles();

        console.log("=== ì—­í•  ë¡œë“œ ì™„ë£Œ, Agora ì‹œì‘ ===");
        await initAgora();
        console.log("=== Agora ì™„ë£Œ, WebSocket ì‹œì‘ ===");
        connectWebSocket();
        startTimer();

        if (currentUserRole === "HOST" || currentUserRole === "REVIEWER") {
          console.log("=== HOST/REVIEWER ëª¨ë“œ: ë©´ì ‘ì ë¡œë“œ ì‹œì‘ ===");

          let attempt = 0;
          const maxAttempts = 5;
          const loadWithRetry = async () => {
            attempt++;
            console.log(`ğŸ“‹ ë©´ì ‘ì ë¡œë”© ì‹œë„ ${attempt}/${maxAttempts}`);

            const success = await loadInterviewees();

            if (!success && attempt < maxAttempts) {
              console.log(`â³ 2ì´ˆ í›„ ì¬ì‹œë„...`);
              setTimeout(loadWithRetry, 2000);
            } else if (success) {
              console.log("âœ… ë©´ì ‘ì ë¡œë”© ì™„ë£Œ!");
            } else {
              console.error("âŒ ë©´ì ‘ì ë¡œë”© ìµœì¢… ì‹¤íŒ¨");
            }
          };

          setTimeout(loadWithRetry, 3000);
        }

        initVoiceRecognition();

        console.log("=== ì´ˆê¸°í™” ì™„ë£Œ ===");
      }

      function initVoiceRecognition() {
        if (
          !("webkitSpeechRecognition" in window) &&
          !("SpeechRecognition" in window)
        ) {
          console.warn("Web Speech API not supported");
          const voiceQuestionBtn = document.getElementById("voiceQuestionBtn");
          const voiceAnswerBtn = document.getElementById("voiceAnswerBtn");
          if (voiceQuestionBtn) voiceQuestionBtn.style.display = "none";
          if (voiceAnswerBtn) voiceAnswerBtn.style.display = "none";
          return;
        }

        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = "ko-KR";
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.maxAlternatives = 1;

        recognition.onresult = function (event) {
          let interim = "";
          let final = "";

          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              final += transcript + " ";
            } else {
              interim += transcript;
            }
          }

          if (final) {
            final = filterHallucination(final);
            if (final.trim()) {
              finalTranscript += final;
            }
          }

          interimTranscript = interim;
          updateSubtitle(finalTranscript, interimTranscript);

          broadcastSubtitle(finalTranscript, interimTranscript);
        };

        recognition.onerror = function (event) {
          console.error("Speech recognition error:", event.error);
          if (event.error === "no-speech") {
            console.log("No speech detected");
          }
        };

        recognition.onend = function () {
          if (isRecordingQuestion || isRecordingAnswer) {
            recognition.start();
          }
        };

        console.log("âœ… ìŒì„± ì¸ì‹ ì´ˆê¸°í™” ì™„ë£Œ");
      }

      function filterHallucination(text) {
        const hallucinationPatterns = [
          /ì¢‹ì€\s*ë‚ \s*ì”¹ë‹ˆë‹¤/g,
          /ì‹œì²­í•´\s*ì£¼ì…”ì„œ\s*ê°ì‚¬í•©ë‹ˆë‹¤/g,
          /êµ¬ë…\s*ì¢‹ì•„ìš”/g,
          /ì•ŒëŒ\s*ì„¤ì •/g,
          /ìë§‰\s*ì œê³µ/g,
          /\[ìŒì•…\]/g,
          /\[ë°•ìˆ˜\]/g,
          /\[\s*\]/g,
          /MBC\s*ë‰´ìŠ¤/g,
          /KBS\s*ë‰´ìŠ¤/g,
          /ì—°í•©ë‰´ìŠ¤/g,
          /ìë§‰\s*:\s*/g,
        ];

        let filtered = text;
        hallucinationPatterns.forEach((pattern) => {
          filtered = filtered.replace(pattern, "");
        });

        filtered = filtered.trim();

        if (filtered.length < 2) {
          return "";
        }

        return filtered;
      }

      function broadcastSubtitle(finalText, interimText) {
        if (!stompClient || !stompClient.connected) return;

        const text = finalText + (interimText ? " " + interimText : "");
        if (!text.trim()) return;

        stompClient.send(
          `/app/session/${sessionId}/subtitle`,
          {},
          JSON.stringify({
            userId: currentUserId,
            speaker: currentUserName,
            text: text,
            isFinal: interimText === "",
          })
        );
      }

      function toggleVoiceQuestion() {
    const btn = document.getElementById("voiceQuestionBtn");

    if (!isRecordingQuestion) {
        finalTranscript = "";
        interimTranscript = "";
        isRecordingQuestion = true;
        isRecordingAnswer = false;

        try {
            recognition.start();
            btn.textContent = "â¹ï¸ ì§ˆë¬¸ ì™„ë£Œ (ì „ì†¡)";
            btn.classList.add("recording");
            console.log("ğŸ¤ ì§ˆë¬¸ ë…¹ìŒ ì‹œì‘");
        } catch (e) {
            console.error("Recognition start error:", e);
        }
    } else {
        if (recognition) {
            recognition.stop();
        }
        btn.textContent = "ğŸ¤ ìŒì„±ìœ¼ë¡œ ì§ˆë¬¸í•˜ê¸°";
        btn.classList.remove("recording");
        isRecordingQuestion = false;

        setTimeout(() => {
            if (finalTranscript.trim()) {
                addPermanentSubtitle(finalTranscript, currentUserName);
                sendVoiceQuestion();
            }
        }, 500);

        console.log("â¹ï¸ ì§ˆë¬¸ ë…¹ìŒ ì¤‘ì§€ ë° ì „ì†¡");
    }
}
      function toggleVoiceAnswer() {
    const btn = document.getElementById("voiceAnswerBtn");

    if (!isRecordingAnswer) {
        finalTranscript = "";
        interimTranscript = "";
        isRecordingAnswer = true;
        isRecordingQuestion = false;

        try {
            recognition.start();
            btn.textContent = "â¹ï¸ ë‹µë³€ ì™„ë£Œ (ì „ì†¡)";
            btn.classList.add("recording");
            console.log("ğŸ¤ ë‹µë³€ ë…¹ìŒ ì‹œì‘");
        } catch (e) {
            console.error("Recognition start error:", e);
        }
    } else {
        if (recognition) {
            recognition.stop();
        }
        btn.textContent = "ğŸ¤ ìŒì„±ìœ¼ë¡œ ë‹µë³€í•˜ê¸°";
        btn.classList.remove("recording");
        isRecordingAnswer = false;

        setTimeout(() => {
            if (finalTranscript.trim()) {
                addPermanentSubtitle(finalTranscript, currentUserName);
                sendVoiceAnswer();
            }
        }, 500);

        console.log("â¹ï¸ ë‹µë³€ ë…¹ìŒ ì¤‘ì§€ ë° ì „ì†¡");
    }
}

      async function sendVoiceQuestion() {
        const question = finalTranscript.trim();

        if (!question) {
          alert("ì§ˆë¬¸ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤");
          return;
        }

        if (!stompClient || !stompClient.connected) {
          alert("ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤");
          return;
        }

        try {
          const response = await fetch(`/api/session/${sessionId}/questions`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: getCookie("Authorization"),
            },
            body: JSON.stringify({
              text: question,
              orderNo: 0,
            }),
          });

          if (response.ok) {
            console.log("âœ… ì§ˆë¬¸ DB ì €ì¥ ì™„ë£Œ");
          }
        } catch (error) {
          console.error("âŒ ì§ˆë¬¸ DB ì €ì¥ ì‹¤íŒ¨:", error);
        }

        stompClient.send(
          `/app/session/${sessionId}/question`,
          {},
          JSON.stringify({
            content: question,
            userId: currentUserId,
            author: currentUserName || `User ${currentUserId}`,
          })
        );

        finalTranscript = "";
        interimTranscript = "";
        console.log("ğŸ“¤ ìŒì„± ì§ˆë¬¸ ì „ì†¡:", question);
      }

      function sendVoiceAnswer() {
        const answer = finalTranscript.trim();

        if (!answer) {
          alert("ë‹µë³€ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤");
          return;
        }

        if (!stompClient || !stompClient.connected) {
          alert("ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤");
          return;
        }

        const payload = {
          sessionId: sessionId,
          userId: currentUserId,
          userName: currentUserName || `User ${currentUserId}`,
          answerText: answer,
          timestamp: new Date().toISOString(),
        };

        console.log("ğŸ“¤ ìŒì„± ë‹µë³€ ì „ì†¡ payload:", payload);

        stompClient.send(
          `/app/session/${sessionId}/answer`,
          {},
          JSON.stringify(payload)
        );

        finalTranscript = "";
        interimTranscript = "";
        console.log("ğŸ“¤ ìŒì„± ë‹µë³€ ì „ì†¡ ì™„ë£Œ");
      }

      function updateSubtitle(finalText, interimText) {
        const container = document.getElementById("subtitleContent");

        let lastPermanent = container.querySelector(
          ".subtitle-permanent:last-child"
        );
        if (!lastPermanent) {
          lastPermanent = document.createElement("div");
          lastPermanent.className = "subtitle-permanent";
          lastPermanent.style.marginBottom = "8px";
          container.appendChild(lastPermanent);
        }

        lastPermanent.innerHTML = "";

        if (finalText) {
          const finalSpan = document.createElement("span");
          finalSpan.className = "subtitle-text";
          finalSpan.textContent = finalText;
          lastPermanent.appendChild(finalSpan);
        }

        if (interimText) {
          const interimSpan = document.createElement("span");
          interimSpan.className = "subtitle-interim";
          interimSpan.textContent = " " + interimText;
          lastPermanent.appendChild(interimSpan);
        }

        container.parentElement.scrollTop =
          container.parentElement.scrollHeight;
      }

      function addPermanentSubtitle(text, speaker) {
        const container = document.getElementById("subtitleContent");

        const emptyMsg = container.querySelector(
          'span[style*="color: #9ca3af"]'
        );
        if (emptyMsg) {
          emptyMsg.remove();
        }

        const permanentDiv = document.createElement("div");
        permanentDiv.className = "subtitle-permanent";
        permanentDiv.style.marginBottom = "8px";

        const speakerSpan = document.createElement("strong");
        speakerSpan.textContent = speaker + ": ";
        speakerSpan.style.color = "#667eea";

        const textSpan = document.createElement("span");
        textSpan.className = "subtitle-text";
        textSpan.textContent = text;

        permanentDiv.appendChild(speakerSpan);
        permanentDiv.appendChild(textSpan);
        container.appendChild(permanentDiv);

        container.parentElement.scrollTop =
          container.parentElement.scrollHeight;
      }

      function clearSubtitle() {
        const container = document.getElementById("subtitleContent");
        container.innerHTML =
          '<span style="color: #9ca3af;">ìë§‰ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</span>';
      }

      async function joinSession() {
        try {
          console.log("ğŸšª ì„¸ì…˜ ì°¸ê°€ API í˜¸ì¶œ");
          const response = await fetch(
            `/api/session/${sessionId}/participants/join?role=${currentUserRole}`,
            {
              method: "POST",
              headers: {
                Authorization: getCookie("Authorization"),
              },
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const result = await response.json();
          console.log("âœ… ì„¸ì…˜ ì°¸ê°€ ì™„ë£Œ:", result);
        } catch (error) {
          console.error("âŒ ì„¸ì…˜ ì°¸ê°€ ì‹¤íŒ¨:", error);
        }
      }

      async function loadParticipantRoles() {
        let retries = 0;
        const maxRetries = 3;

        while (retries < maxRetries) {
          try {
            console.log(
              `ğŸ” API í˜¸ì¶œ (ì‹œë„ ${
                retries + 1
              }/${maxRetries}): /api/session/${sessionId}/participants`
            );
            const response = await fetch(
              `/api/session/${sessionId}/participants`
            );

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }

            const participants = await response.json();

            console.log("=== ì°¸ê°€ì ì›ë³¸ ë°ì´í„° ===");
            console.log(JSON.stringify(participants, null, 2));

            if (!Array.isArray(participants)) {
              console.error("âŒ ì‘ë‹µì´ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:", participants);
              retries++;
              await new Promise((resolve) => setTimeout(resolve, 1000));
              continue;
            }

            if (participants.length === 0) {
              console.warn(
                `âš ï¸ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤! (ì‹œë„ ${retries + 1}/${maxRetries})`
              );
              retries++;
              await new Promise((resolve) => setTimeout(resolve, 1000));
              continue;
            }

            participantRoles = {};
            participantNames = {};

            participants.forEach((p) => {
              console.log(
                `ğŸ‘¤ User ${p.userId}: role=${p.role}, name=${p.userName}`
              );
              participantRoles[p.userId] = p.role;
              participantNames[p.userId] = p.userName || `User ${p.userId}`;
            });

            console.log("âœ… ì°¸ê°€ì ì—­í•  ë§¤í•‘:", participantRoles);
            console.log("âœ… ì°¸ê°€ì ì´ë¦„ ë§¤í•‘:", participantNames);
            console.log("âœ… í˜„ì¬ ì‚¬ìš©ì ì—­í• :", currentUserRole);

            if (Object.keys(participantRoles).length > 0) {
              return;
            }
          } catch (error) {
            console.error(
              `âŒ ì°¸ê°€ì ì—­í•  ë¡œë“œ ì‹¤íŒ¨ (ì‹œë„ ${retries + 1}):`,
              error
            );
          }

          retries++;
          if (retries < maxRetries) {
            await new Promise((resolve) => setTimeout(resolve, 1000));
          }
        }

        console.error("âŒ ì°¸ê°€ì ì—­í•  ë¡œë“œ ìµœì¢… ì‹¤íŒ¨");
      }

      function connectWebSocket() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect(
          {},
          function (frame) {
            console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ");

            stompClient.subscribe(
              `/topic/session/${sessionId}/question`,
              function (message) {
                const data = JSON.parse(message.body);
                console.log("ğŸ“© ì§ˆë¬¸ ìˆ˜ì‹ :", data);
                questionCount++;
                qaList.push({
                  type: "question",
                  number: questionCount,
                  author: data.author || "ë©´ì ‘ê´€",
                  content: data.content,
                  time: new Date().toLocaleTimeString(),
                  userId: data.userId,
                });
                renderQA();
              }
            );

            stompClient.subscribe(
              `/topic/session/${sessionId}/answer`,
              function (message) {
                const data = JSON.parse(message.body);
                console.log("ğŸ“© ë‹µë³€ ìˆ˜ì‹ :", data);

                if (data.userId === currentUserId && data.answerId) {
                  window.lastAnswerId = data.answerId;
                  console.log("âœ… ë‚´ ë‹µë³€ ID ì €ì¥:", data.answerId);
                }

                answerCount++;
                qaList.push({
                  type: "answer",
                  number: answerCount,
                  author: data.userName || data.author || "ë©´ì ‘ì",
                  content: data.answerText || data.content || "",
                  time: new Date().toLocaleTimeString(),
                  userId: data.userId,
                  answerId: data.answerId,
                });
                renderQA();
              }
            );

            stompClient.subscribe(
              `/topic/session/${sessionId}`,
              function (message) {
                const data = JSON.parse(message.body);
                console.log("ğŸ“© ì¼ë°˜ ë©”ì‹œì§€ ìˆ˜ì‹ :", data);

                if (Array.isArray(data)) {
                  console.log("ğŸ“‹ ì°¸ê°€ì ëª©ë¡ ì—…ë°ì´íŠ¸:", data);

                  data.forEach((p) => {
                    participantRoles[p.userId] = p.role;
                    participantNames[p.userId] =
                      p.userName || `User ${p.userId}`;
                    console.log(
                      `ğŸ”„ ë§¤í•‘: userId=${p.userId}, role=${p.role}, name=${p.userName}`
                    );
                  });

                  console.log("âœ… ì—­í•  ë§¤í•‘ ì—…ë°ì´íŠ¸:", participantRoles);

                  if (
                    currentUserRole === "HOST" ||
                    currentUserRole === "REVIEWER"
                  ) {
                    console.log("ğŸ‘¥ ë©´ì ‘ì ë¦¬ìŠ¤íŠ¸ ì¦‰ì‹œ ì—…ë°ì´íŠ¸");
                    updateIntervieweeList(data);
                  }
                }
              }
            );

            stompClient.subscribe(
              `/topic/session/${sessionId}/subtitle`,
              function (message) {
                const data = JSON.parse(message.body);
                console.log("ğŸ“º ìë§‰ ìˆ˜ì‹ :", data);

                if (
                  data.userId === currentUserId &&
                  data.isFinal &&
                  data.answerId
                ) {
                  window.lastAnswerId = data.answerId;
                  console.log("âœ… ìë§‰ ë‹µë³€ ID ì €ì¥:", data.answerId);
                }

                if (data.userId !== currentUserId && data.isFinal) {
                  addPermanentSubtitle(data.text, data.speaker);
                }
              }
            );

            stompClient.send(
              `/app/session/${sessionId}/join`,
              {},
              JSON.stringify({
                userId: currentUserId,
                role: currentUserRole,
              })
            );
          },
          function (error) {
            console.error("âŒ WebSocket ì—°ê²° ì‹¤íŒ¨:", error);
            setTimeout(connectWebSocket, 5000);
          }
        );
      }

      function handleWebSocketMessage(data) {
        const select = document.getElementById("intervieweeSelect");
        if (!select) return;

        const currentValue = select.value;
        select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';

        participants
          .filter((p) => p.role === "STUDENT")
          .forEach((p) => {
            const option = document.createElement("option");
            option.value = p.userId;
            option.textContent = p.userName;
            select.appendChild(option);
          });

        if (currentValue) {
          select.value = currentValue;
        }
      }

      function toggleEvaluationPanel() {
        const panel = document.getElementById("evaluationPanel");
        const icon = document.getElementById("evalToggleIcon");
        if (panel.style.display === "none") {
          panel.style.display = "block";
          icon.style.transform = "rotate(180deg)";
        } else {
          panel.style.display = "none";
          icon.style.transform = "rotate(0deg)";
        }
      }

      async function loadInterviewees() {
        try {
          console.log("=== ë©´ì ‘ì ë“œë¡­ë‹¤ìš´ ë¡œë“œ ì‹œì‘ ===");
          const response = await fetch(
            `/api/session/${sessionId}/participants`
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const participants = await response.json();
          console.log("ğŸ“‹ ì „ì²´ ì°¸ê°€ì:", participants);

          if (!Array.isArray(participants)) {
            console.error("âŒ ì‘ë‹µì´ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:", participants);
            return false;
          }

          const students = participants.filter((p) => {
            console.log(
              `ğŸ” ì°¸ê°€ì ${p.userId} (${p.userName}): role=${p.role}`
            );
            return p.role === "STUDENT";
          });

          console.log("ğŸ“ í•„í„°ë§ëœ í•™ìƒ:", students);

          const select = document.getElementById("intervieweeSelect");
          if (!select) {
            console.warn("âš ï¸ intervieweeSelect ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤");
            return false;
          }

          select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';

          students.forEach((student) => {
            const option = document.createElement("option");
            option.value = student.userId;
            option.textContent = student.userName || `User ${student.userId}`;
            select.appendChild(option);
            console.log(
              `âœ… ì¶”ê°€ëœ ì˜µì…˜: ${option.textContent} (${option.value})`
            );
          });

          console.log(`âœ… ì´ ${students.length}ëª…ì˜ ë©´ì ‘ì ë¡œë“œ ì™„ë£Œ`);
          return students.length > 0;
        } catch (error) {
          console.error("âŒ ë©´ì ‘ì ë¡œë“œ ì‹¤íŒ¨:", error);
          return false;
        }
      }

      function updateIntervieweeList(participants) {
        const select = document.getElementById("intervieweeSelect");
        if (!select) return;

        const currentValue = select.value;
        select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';

        const students = participants.filter((p) => p.role === "STUDENT");
        console.log("=== WebSocket ì—…ë°ì´íŠ¸ë¡œ ë©´ì ‘ì ë¦¬ìŠ¤íŠ¸ ê°±ì‹  ===");
        console.log("í•™ìƒ ìˆ˜:", students.length);

        students.forEach((student) => {
          const option = document.createElement("option");
          option.value = student.userId;
          option.textContent = student.userName || `User ${student.userId}`;
          select.appendChild(option);
        });

        if (currentValue) {
          select.value = currentValue;
        }
      }

      function setRating(rating) {
        currentRating = rating;
        const stars = document.querySelectorAll(".star");
        stars.forEach((star, index) => {
          if (index < rating) {
            star.classList.add("active");
          } else {
            star.classList.remove("active");
          }
        });
      }

      function saveEvaluation() {
        const userId = document.getElementById("intervieweeSelect").value;
        if (!userId) {
          alert("ë©´ì ‘ìë¥¼ ì„ íƒí•˜ì„¸ìš”");
          return;
        }

        evaluations[userId] = {
          rating: currentRating,
          strengths: document.getElementById("strengths").value,
          weaknesses: document.getElementById("weaknesses").value,
          improvements: document.getElementById("improvements").value,
          notes: document.getElementById("notes").value,
        };

        alert("ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤");
      }

      function loadSavedEvaluation() {
        const userId = document.getElementById("intervieweeSelect").value;
        if (!userId) {
          setRating(0);
          document.getElementById("strengths").value = "";
          document.getElementById("weaknesses").value = "";
          document.getElementById("improvements").value = "";
          document.getElementById("notes").value = "";
          return;
        }

        const saved = evaluations[userId];
        if (saved) {
          setRating(saved.rating);
          document.getElementById("strengths").value = saved.strengths;
          document.getElementById("weaknesses").value = saved.weaknesses;
          document.getElementById("improvements").value = saved.improvements;
          document.getElementById("notes").value = saved.notes;
        } else {
          setRating(0);
          document.getElementById("strengths").value = "";
          document.getElementById("weaknesses").value = "";
          document.getElementById("improvements").value = "";
          document.getElementById("notes").value = "";
        }
      }

      async function loadIntervieweeData() {
        const userId = document.getElementById("intervieweeSelect").value;

        if (!userId) {
          document.getElementById("aiFeedbackSection").style.display = "none";
          loadSavedEvaluation();
          return;
        }

        console.log("ğŸ“Š ë©´ì ‘ì ë°ì´í„° ë¡œë“œ:", userId);

        try {
          const response = await fetch(
            `/api/session/${sessionId}/interviewee/${userId}/feedback`
          );

          if (response.ok) {
            const data = await response.json();
            console.log("âœ… AI í”¼ë“œë°± ë°ì´í„°:", data);

            if (data.aiFeedback) {
              document.getElementById("aiFeedbackSection").style.display =
                "block";

              document.getElementById(
                "aiStrengths"
              ).innerHTML = `<strong style="color: #10b981;">ğŸ’ª ê°•ì :</strong> ${
                data.aiFeedback.strengths || "ë¶„ì„ ì¤‘..."
              }`;

              document.getElementById(
                "aiWeaknesses"
              ).innerHTML = `<strong style="color: #f59e0b;">âš ï¸ ì•½ì :</strong> ${
                data.aiFeedback.weaknesses || "ë¶„ì„ ì¤‘..."
              }`;

              document.getElementById(
                "aiImprovements"
              ).innerHTML = `<strong style="color: #3b82f6;">ğŸ’¡ ê°œì„ :</strong> ${
                data.aiFeedback.improvements || "ë¶„ì„ ì¤‘..."
              }`;

              window.currentAIFeedback = data.aiFeedback;
            } else {
              document.getElementById("aiFeedbackSection").style.display =
                "none";
            }
          } else {
            console.warn("âš ï¸ AI í”¼ë“œë°± ì—†ìŒ");
            document.getElementById("aiFeedbackSection").style.display = "none";
          }
        } catch (error) {
          console.error("âŒ AI í”¼ë“œë°± ë¡œë“œ ì‹¤íŒ¨:", error);
          document.getElementById("aiFeedbackSection").style.display = "none";
        }

        loadSavedEvaluation();
      }

      function copyAIToForm() {
        if (!window.currentAIFeedback) {
          alert("AI í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤");
          return;
        }

        const ai = window.currentAIFeedback;
        document.getElementById("strengths").value = ai.strengths || "";
        document.getElementById("weaknesses").value = ai.weaknesses || "";
        document.getElementById("improvements").value = ai.improvements || "";

        alert("AI í”¼ë“œë°±ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. í•„ìš”ì— ë”°ë¼ ìˆ˜ì •í•˜ì„¸ìš”.");
      }

      async function submitEvaluation() {
        const userId = document.getElementById("intervieweeSelect").value;
        if (!userId) {
          alert("ë©´ì ‘ìë¥¼ ì„ íƒí•˜ì„¸ìš”");
          return;
        }

        if (currentRating === 0) {
          alert("í‰ê°€ ì ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”");
          return;
        }

        const payload = {
          intervieweeId: parseInt(userId),
          rating: currentRating,
          strengths: document.getElementById("strengths").value,
          weaknesses: document.getElementById("weaknesses").value,
          improvements: document.getElementById("improvements").value,
          notes: document.getElementById("notes").value,
        };

        console.log("ğŸ“¤ í‰ê°€ ì œì¶œ payload:", payload);

        try {
          const response = await fetch(`/api/session/${sessionId}/feedback`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: getCookie("Authorization"),
            },
            body: JSON.stringify(payload),
          });

          console.log("ğŸ“¥ í‰ê°€ ì œì¶œ ì‘ë‹µ ìƒíƒœ:", response.status);

          if (response.ok) {
            const result = await response.json();
            console.log("âœ… í‰ê°€ ì œì¶œ ì„±ê³µ:", result);
            alert("í‰ê°€ ì œì¶œ ì™„ë£Œ");
            delete evaluations[userId];
            loadIntervieweeData();
          } else {
            const errorData = await response.json();
            console.error("âŒ í‰ê°€ ì œì¶œ ì‹¤íŒ¨:", response.status, errorData);
            alert(`í‰ê°€ ì œì¶œ ì‹¤íŒ¨: ${errorData.message || "ì„œë²„ ì—ëŸ¬"}`);
          }
        } catch (error) {
          console.error("âŒ í‰ê°€ ì œì¶œ ì˜¤ë¥˜:", error);
          alert("í‰ê°€ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
        }
      }

      async function initAgora() {
        try {
          console.log("ğŸ” ë¯¸ë””ì–´ ê¶Œí•œ í™•ì¸...");
          await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true,
          });
          console.log("âœ… ë¯¸ë””ì–´ ê¶Œí•œ ìŠ¹ì¸ë¨");
        } catch (error) {
          console.error("âŒ ë¯¸ë””ì–´ ê¶Œí•œ ê±°ë¶€:", error);
          alert(
            "ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”."
          );
          throw error;
        }

        agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

        agoraClient.on("network-quality", (stats) => {
          if (
            stats.downlinkNetworkQuality > 3 ||
            stats.uplinkNetworkQuality > 3
          ) {
            console.warn("âš ï¸ ë„¤íŠ¸ì›Œí¬ í’ˆì§ˆ ì €í•˜:", stats);
          }
        });

        agoraClient.on("connection-state-change", (curState, revState) => {
          console.log(`ğŸ”Œ ì—°ê²° ìƒíƒœ ë³€ê²½: ${revState} â†’ ${curState}`);
          if (curState === "DISCONNECTED") {
            console.error("âŒ Agora ì—°ê²° ëŠê¹€!");
          }
        });

        agoraClient.on("user-published", async (user, mediaType) => {
          try {
            await agoraClient.subscribe(user, mediaType);
            console.log("âœ… User published:", user.uid, mediaType);

            if (mediaType === "video") {
              const remoteVideoTrack = user.videoTrack;
              const userId = user.uid;

              console.log(`=== ë¹„ë””ì˜¤ ì¶”ê°€ ì‹œë„ ===`);
              console.log(`User ID: ${userId}`);
              console.log(`í˜„ì¬ ì‚¬ìš©ì ID: ${currentUserId}`);
              console.log(`ë§¤í•‘ëœ ì—­í• : ${participantRoles[userId]}`);
              console.log(`ì „ì²´ ì—­í•  ë§¤í•‘:`, participantRoles);

              const userRole = participantRoles[userId] || "STUDENT";
              console.log(`ìµœì¢… ì—­í• : ${userRole}`);

              const container =
                userRole === "HOST" || userRole === "REVIEWER"
                  ? document.getElementById("interviewerVideos")
                  : document.getElementById("intervieweeVideos");

              console.log(`ì»¨í…Œì´ë„ˆ: ${container.id}`);

              let videoWrapper = document.getElementById(`video-${userId}`);
              if (!videoWrapper) {
                videoWrapper = document.createElement("div");
                videoWrapper.className = "video-wrapper";
                videoWrapper.id = `video-${userId}`;

                const label = document.createElement("div");
                label.className =
                  "video-label" +
                  (userRole === "HOST" || userRole === "REVIEWER"
                    ? " interviewer-badge"
                    : "");
                label.id = `label-${userId}`;
                const displayName =
                  participantNames[userId] || `User ${userId}`;
                const roleText =
                  userRole === "HOST" || userRole === "REVIEWER"
                    ? " ğŸ‘”"
                    : " ğŸ“";
                label.textContent = displayName + roleText;

                videoWrapper.appendChild(label);
                container.appendChild(videoWrapper);
              }

              setTimeout(() => {
                try {
                  remoteVideoTrack.play(`video-${userId}`, { fit: "cover" });
                  console.log(`âœ… ë¹„ë””ì˜¤ í”Œë ˆì´ ì™„ë£Œ: ${userId}`);
                } catch (playError) {
                  console.error(`âŒ ë¹„ë””ì˜¤ í”Œë ˆì´ ì‹¤íŒ¨: ${userId}`, playError);
                }
              }, 200);

              console.log(
                `âœ… ë¹„ë””ì˜¤ ì¶”ê°€ ì™„ë£Œ: ${
                  participantNames[userId] || userId
                }, Role: ${userRole}`
              );
            }

            if (mediaType === "audio") {
              const remoteAudioTrack = user.audioTrack;
              remoteAudioTrack.play();
              console.log(`âœ… ì˜¤ë””ì˜¤ í”Œë ˆì´ ì™„ë£Œ: ${user.uid}`);
            }
          } catch (error) {
            console.error(`âŒ user-published ì²˜ë¦¬ ì‹¤íŒ¨:`, error);
          }
        });

        agoraClient.on("user-unpublished", (user) => {
          const videoElement = document.getElementById(`video-${user.uid}`);
          if (videoElement) {
            videoElement.remove();
          }
        });

        try {
          console.log("=== Agora ì—°ê²° ì‹œë„ (Testing Mode) ===");
          console.log("App ID:", agoraAppId);
          console.log("Channel:", agoraChannel);
          console.log("UID:", parseInt(currentUserId));
          console.log("Token: null (Testing Mode)");

          await agoraClient.join(
            agoraAppId,
            agoraChannel,
            null,
            parseInt(currentUserId)
          );
          console.log("âœ… Agora ì—°ê²° ì„±ê³µ!");
        } catch (error) {
          console.error("âŒ Agora ì—°ê²° ì‹¤íŒ¨:", error);
          console.error("Error Code:", error.code);
          console.error("Error Message:", error.message);
          alert(`Agora ì—°ê²° ì‹¤íŒ¨: ${error.message}`);
          throw error;
        }

        try {
          console.log("ğŸ“¹ ì¹´ë©”ë¼ íŠ¸ë™ ìƒì„± ì‹œë„...");
          localVideoTrack = await AgoraRTC.createCameraVideoTrack({
            encoderConfig: "720p_2",
          });
          console.log("âœ… ì¹´ë©”ë¼ íŠ¸ë™ ìƒì„± ì„±ê³µ");
        } catch (error) {
          console.error("âŒ ì¹´ë©”ë¼ íŠ¸ë™ ìƒì„± ì‹¤íŒ¨:", error);
          alert("ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
          throw error;
        }

        try {
          console.log("ğŸ¤ ë§ˆì´í¬ íŠ¸ë™ ìƒì„± ì‹œë„...");
          localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack({
            AEC: true,
            ANS: true,
          });
          console.log("âœ… ë§ˆì´í¬ íŠ¸ë™ ìƒì„± ì„±ê³µ");
        } catch (error) {
          console.error("âŒ ë§ˆì´í¬ íŠ¸ë™ ìƒì„± ì‹¤íŒ¨:", error);
          alert("ë§ˆì´í¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
          throw error;
        }

        const container =
          currentUserRole === "HOST" || currentUserRole === "REVIEWER"
            ? document.getElementById("interviewerVideos")
            : document.getElementById("intervieweeVideos");

        const videoWrapper = document.createElement("div");
        videoWrapper.className = "video-wrapper";
        videoWrapper.id = `video-${currentUserId}`;

        const label = document.createElement("div");
        label.className =
          "video-label" +
          (currentUserRole === "HOST" || currentUserRole === "REVIEWER"
            ? " interviewer-badge"
            : "");
        label.id = `label-${currentUserId}`;
        const userName = participantNames[currentUserId] || "ë‚˜";
        const roleEmoji =
          currentUserRole === "HOST" || currentUserRole === "REVIEWER"
            ? " ğŸ‘”"
            : " ğŸ“";
        label.textContent = userName + roleEmoji;

        videoWrapper.appendChild(label);
        container.appendChild(videoWrapper);

        localVideoTrack.play(`video-${currentUserId}`, { fit: "cover" });

        await agoraClient.publish([localAudioTrack, localVideoTrack]);
        console.log("âœ… ë¡œì»¬ ë¯¸ë””ì–´ ë°œí–‰ ì™„ë£Œ:", userName);
      }

      function renderQA() {
        const container = document.getElementById("qaContainer");

        if (qaList.length === 0) {
          container.innerHTML =
            '<p style="text-align: center; color: #9ca3af; font-size: 0.875rem;">ì§ˆë¬¸ê³¼ ë‹µë³€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>';
          return;
        }

        container.innerHTML = qaList
          .map(
            (item) => `
            <div class="qa-item">
                <div class="qa-header">
                    <span class="qa-badge ${
                      item.type === "question"
                        ? "question-badge"
                        : "answer-badge"
                    }">
                        ${item.type === "question" ? "ì§ˆë¬¸" : "ë‹µë³€"} ${
              item.number
            }
                    </span>
                    <span class="qa-author">${item.author}</span>
                </div>
                <div class="qa-content">${item.content}</div>
                <div class="qa-time">${item.time}</div>
            </div>
        `
          )
          .join("");

        container.scrollTop = container.scrollHeight;
      }

      function toggleAI() {
        const aiPanel = document.getElementById("aiPanel");
        const aiToggle = document.getElementById("aiToggle");
        const aiToggleLabel = document.getElementById("aiToggleLabel");

        if (aiToggle.checked) {
          aiPanel.style.display = "block";
          aiToggleLabel.textContent = "ON";
        } else {
          aiPanel.style.display = "none";
          aiToggleLabel.textContent = "OFF";
        }
      }

      async function requestAIFeedback() {
        console.log("ğŸ¤– AI í”¼ë“œë°± ìš”ì²­ ì‹œì‘");

        const feedbackQAList = [...qaList];

        const subtitleMessages = document.querySelectorAll(
          "#subtitleContent .subtitle-permanent"
        );
        if (subtitleMessages.length > 0) {
          subtitleMessages.forEach((subtitle) => {
            const fullText = subtitle.textContent;
            const colonIndex = fullText.indexOf(":");

            if (colonIndex > 0) {
              const speaker = fullText.substring(0, colonIndex).trim();
              const content = fullText.substring(colonIndex + 1).trim();

              if (content && content !== "ìë§‰ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...") {
                feedbackQAList.push({
                  type: speaker.includes("ì§ˆë¬¸") ? "question" : "answer",
                  content: content,
                  author: speaker.replace(" (ì§ˆë¬¸)", "").replace(" (ë‹µë³€)", ""),
                });
              }
            }
          });
        }

        if (feedbackQAList.length === 0) {
          alert("í”¼ë“œë°±í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤");
          return;
        }

        console.log("ğŸ“‹ í”¼ë“œë°± ëŒ€ìƒ:", feedbackQAList);

        const aiFeedbackDiv = document.getElementById("aiFeedback");
        aiFeedbackDiv.innerHTML = "â³ AI í”¼ë“œë°± ìƒì„± ì¤‘...";

        try {
          const response = await fetch(
            `/api/session/${sessionId}/ai-feedback`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: getCookie("Authorization"),
              },
              body: JSON.stringify({
                qaList: feedbackQAList,
              }),
            }
          );

          if (response.ok) {
            const feedback = await response.json();
            aiFeedbackDiv.innerHTML = `
                    <div><strong>ğŸ’ª ê°•ì :</strong> ${
                      feedback.strengths || "N/A"
                    }</div>
                    <div><strong>âš ï¸ ì•½ì :</strong> ${
                      feedback.weaknesses || "N/A"
                    }</div>
                    <div><strong>ğŸ’¡ ê°œì„ :</strong> ${
                      feedback.improvements || "N/A"
                    }</div>
                `;
          } else {
            throw new Error("AI í”¼ë“œë°± ìš”ì²­ ì‹¤íŒ¨");
          }
        } catch (error) {
          console.error("AI í”¼ë“œë°± ì˜¤ë¥˜:", error);
          aiFeedbackDiv.innerHTML = "âŒ AI í”¼ë“œë°± ìƒì„± ì‹¤íŒ¨";
        }
      }

      let timerSeconds = 0;
      let timerInterval = null;

      function startTimer() {
        timerInterval = setInterval(() => {
          timerSeconds++;
          const hours = Math.floor(timerSeconds / 3600);
          const minutes = Math.floor((timerSeconds % 3600) / 60);
          const seconds = timerSeconds % 60;

          document.getElementById("timer").textContent = `${String(
            hours
          ).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(
            seconds
          ).padStart(2, "0")}`;
        }, 1000);
      }

      async function toggleMic() {
        if (localAudioTrack) {
          const enabled = localAudioTrack.enabled;
          await localAudioTrack.setEnabled(!enabled);
          event.target.textContent = enabled ? "ğŸ¤ ë§ˆì´í¬ (OFF)" : "ğŸ¤ ë§ˆì´í¬";
        }
      }

      async function toggleCamera() {
        if (localVideoTrack) {
          const enabled = localVideoTrack.enabled;
          await localVideoTrack.setEnabled(!enabled);
          event.target.textContent = enabled ? "ğŸ“¹ ì¹´ë©”ë¼ (OFF)" : "ğŸ“¹ ì¹´ë©”ë¼";
        }
      }

      async function endInterview() {
        const isHost =
          currentUserRole === "HOST" || currentUserRole === "REVIEWER";

        if (isHost) {
          showEndModal();
        } else {
          if (!confirm("ë©´ì ‘ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return;
          }
          await cleanupAndExit();
          window.location.href = "/session/list";
        }
      }

      function showEndModal() {
        const modal = document.createElement("div");
        modal.id = "endModal";
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        `;

        const modalContent = document.createElement("div");
        modalContent.style.cssText = `
            background: white;
            padding: 32px;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        `;

        modalContent.innerHTML = `
            <h2 style="margin-bottom: 24px; color: #667eea;">ğŸ‰ ë©´ì ‘ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h2>
            <p style="margin-bottom: 32px; color: #666; font-size: 16px;">
                ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!<br>
                ì„¸ì…˜ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?
            </p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button onclick="goToSessionList()" style="
                    padding: 12px 24px;
                    background: #667eea;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: 600;
                ">ì„¸ì…˜ ëª©ë¡ìœ¼ë¡œ</button>
                <button onclick="closeEndModal()" style="
                    padding: 12px 24px;
                    background: #e0e0e0;
                    color: #333;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                ">ì·¨ì†Œ</button>
            </div>
        `;

        modal.appendChild(modalContent);
        document.body.appendChild(modal);
      }

      function closeEndModal() {
        const modal = document.getElementById("endModal");
        if (modal) {
          modal.remove();
        }
      }

      async function goToSessionList() {
        await cleanupAndExit();
        window.location.href = "/session/list";
      }

      async function cleanupAndExit() {
        if (recognition) {
          recognition.stop();
        }

        if (timerInterval) {
          clearInterval(timerInterval);
        }

        if (localAudioTrack) {
          localAudioTrack.close();
        }
        if (localVideoTrack) {
          localVideoTrack.close();
        }
        if (agoraClient) {
          await agoraClient.leave();
        }
        if (stompClient) {
          stompClient.send(
            `/app/session/${sessionId}/leave`,
            {},
            JSON.stringify({
              userId: currentUserId,
            })
          );
          stompClient.disconnect();
        }
      }

      async function startRecording() {
        try {
          if (isRecording) {
            console.warn("âš ï¸ ì´ë¯¸ ë…¹í™” ì¤‘ì…ë‹ˆë‹¤");
            return;
          }

          if (mediaRecorder && mediaRecorder.state === "recording") {
            console.warn("âš ï¸ MediaRecorderê°€ ì´ë¯¸ ë…¹í™” ì¤‘ì…ë‹ˆë‹¤");
            return;
          }

          console.log("ğŸ” í™”ë©´ ë…¹í™” API ì§€ì› í™•ì¸...");
          console.log("navigator.mediaDevices:", navigator.mediaDevices);
          console.log(
            "getDisplayMedia:",
            navigator.mediaDevices?.getDisplayMedia
          );

          if (
            !navigator.mediaDevices ||
            !navigator.mediaDevices.getDisplayMedia
          ) {
            console.error("âŒ getDisplayMedia ë¯¸ì§€ì›");
            alert(
              "âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” í™”ë©´ ë…¹í™”ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\ní•´ê²°ë°©ë²•:\n1. Chrome/Edge ìµœì‹  ë²„ì „ ì‚¬ìš©\n2. HTTPSë¡œ ì ‘ì† (https://mockerview.net)\n3. localhostê°€ ì•„ë‹Œ ê²½ìš° ë°˜ë“œì‹œ HTTPS í•„ìš”"
            );
            return;
          }

          console.log("âœ… getDisplayMedia ì§€ì›ë¨");
          console.log("ğŸ¬ ë…¹í™” ì‹œì‘");

          let streamToRecord;

          try {
            console.log("ğŸ–¥ï¸ í™”ë©´ ê³µìœ  ìš”ì²­...");
            streamToRecord = await navigator.mediaDevices.getDisplayMedia({
              video: {
                width: { ideal: 1920 },
                height: { ideal: 1080 },
                frameRate: { ideal: 30 },
              },
              audio: true,
            });
            console.log("âœ… í™”ë©´ ê³µìœ  ìŠ¤íŠ¸ë¦¼ íšë“ ì™„ë£Œ");
          } catch (e) {
            if (e.name === "NotAllowedError") {
              console.log("â„¹ï¸ ì‚¬ìš©ìê°€ í™”ë©´ ê³µìœ  ì·¨ì†Œ");
              return;
            }
            console.error("âŒ í™”ë©´ ê³µìœ  ì‹¤íŒ¨:", e);
            alert(`í™”ë©´ ê³µìœ  ì‹¤íŒ¨: ${e.message}`);
            return;
          }

          if (!streamToRecord || !streamToRecord.active) {
            console.error("âŒ ìŠ¤íŠ¸ë¦¼ì´ í™œì„±í™”ë˜ì§€ ì•ŠìŒ");
            alert("ìŠ¤íŠ¸ë¦¼ì´ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤");
            return;
          }

          const videoTracks = streamToRecord.getVideoTracks();
          if (
            videoTracks.length === 0 ||
            videoTracks[0].readyState !== "live"
          ) {
            console.error("âŒ ë¹„ë””ì˜¤ íŠ¸ë™ì´ ì—†ê±°ë‚˜ ì¢…ë£Œë¨");
            alert("ë¹„ë””ì˜¤ íŠ¸ë™ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
            return;
          }

          console.log("âœ… ë¹„ë””ì˜¤ íŠ¸ë™ í™•ì¸:", videoTracks[0].label);

          recordedChunks = [];
          recordingStream = streamToRecord;

          let options;
          const supportedTypes = [
            "video/webm;codecs=vp9,opus",
            "video/webm;codecs=vp8,opus",
            "video/webm;codecs=vp8",
            "video/webm",
            "video/mp4",
          ];

          for (const type of supportedTypes) {
            if (MediaRecorder.isTypeSupported(type)) {
              options = {
                mimeType: type,
                videoBitsPerSecond: 2500000,
              };
              console.log("âœ… ì§€ì›ë˜ëŠ” ì½”ë±:", type);
              break;
            }
          }

          if (!options) {
            options = {};
            console.warn("âš ï¸ ê¸°ë³¸ ì½”ë± ì‚¬ìš©");
          }

          try {
            mediaRecorder = new MediaRecorder(streamToRecord, options);
            console.log("âœ… MediaRecorder ìƒì„±:", {
              state: mediaRecorder.state,
              mimeType: mediaRecorder.mimeType,
            });
          } catch (e) {
            console.error("âŒ MediaRecorder ìƒì„± ì‹¤íŒ¨:", e);
            alert("MediaRecorderë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + e.message);
            return;
          }

          mediaRecorder.ondataavailable = (event) => {
            if (event.data && event.data.size > 0) {
              recordedChunks.push(event.data);
              console.log(
                `ğŸ“Š ì²­í¬ ìˆ˜ì§‘: ${event.data.size} bytes (ì´ ${recordedChunks.length}ê°œ)`
              );
            }
          };

          mediaRecorder.onstop = async () => {
            console.log("â¹ï¸ ë…¹í™” ì¤‘ì§€ë¨");
            isRecording = false;

            if (recordedChunks.length === 0) {
              console.error("âŒ ë…¹í™” ë°ì´í„° ì—†ìŒ");
              alert("ë…¹í™” ë°ì´í„°ê°€ ìˆ˜ì§‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤");
              return;
            }

            await uploadRecording();
          };

          mediaRecorder.onerror = (event) => {
            console.error("âŒ MediaRecorder ì˜¤ë¥˜:", event.error);
            alert("ë…¹í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + event.error);
            isRecording = false;
          };

          console.log("ğŸ¬ mediaRecorder.start(1000) í˜¸ì¶œ...");
          mediaRecorder.start(1000);
          isRecording = true;

          console.log("âœ… ë…¹í™” ì‹œì‘ ì™„ë£Œ");
          console.log("  - State:", mediaRecorder.state);
          console.log("  - MimeType:", mediaRecorder.mimeType);

          document.getElementById("startRecordBtn").style.display = "none";
          document.getElementById("stopRecordBtn").style.display = "block";
          document.getElementById("recordingIndicator").style.display = "block";

          streamToRecord.getVideoTracks()[0].onended = () => {
            console.log("â„¹ï¸ ì‚¬ìš©ìê°€ í™”ë©´ ê³µìœ  ì¤‘ì§€");
            stopRecording();
          };
        } catch (error) {
          console.error("âŒ ë…¹í™” ì‹œì‘ ì‹¤íŒ¨:", error);
          console.error("Error name:", error.name);
          console.error("Error message:", error.message);
          alert("ë…¹í™” ì‹œì‘ ì‹¤íŒ¨: " + error.message);
          isRecording = false;
        }
      }

      function stopRecording() {
        if (mediaRecorder && isRecording) {
          console.log("â¹ï¸ ë…¹í™” ì¤‘ì§€ ìš”ì²­");

          try {
            if (mediaRecorder.state === "recording") {
              mediaRecorder.stop();
            }
          } catch (error) {
            console.error("âŒ ë…¹í™” ì¤‘ì§€ ì˜¤ë¥˜:", error);
          }

          isRecording = false;

          if (recordingStream) {
            recordingStream.getTracks().forEach((track) => track.stop());
            recordingStream = null;
          }

          document.getElementById("startRecordBtn").style.display = "block";
          document.getElementById("stopRecordBtn").style.display = "none";
          document.getElementById("recordingIndicator").style.display = "none";

          console.log("â¹ï¸ ë…¹í™” ì¤‘ì§€ ì™„ë£Œ");
        }
      }

      async function uploadRecording() {
        try {
          if (recordedChunks.length === 0) {
            console.warn("âš ï¸ ë…¹í™” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤");
            alert("ë…¹í™” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤");
            return;
          }

          console.log("ğŸ“¤ ë…¹í™” ì—…ë¡œë“œ ì‹œì‘:", recordedChunks.length, "ê°œ ì²­í¬");

          const blob = new Blob(recordedChunks, { type: "video/webm" });
          const fileSize = (blob.size / 1024 / 1024).toFixed(2);
          console.log("ğŸ“¦ íŒŒì¼ í¬ê¸°:", fileSize, "MB");

          if (blob.size === 0) {
            console.error("âŒ íŒŒì¼ í¬ê¸° 0ë°”ì´íŠ¸");
            alert("ë…¹í™” íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤");
            return;
          }

          document.getElementById("uploadProgress").style.display = "block";
          document.getElementById("uploadStatus").textContent =
            "ì—…ë¡œë“œ ì¤‘... (0%)";

          const formData = new FormData();
          formData.append(
            "video",
            blob,
            `recording_${sessionId}_${Date.now()}.webm`
          );

          const xhr = new XMLHttpRequest();

          xhr.upload.addEventListener("progress", (e) => {
            if (e.lengthComputable) {
              const percentComplete = Math.round((e.loaded / e.total) * 100);
              document.getElementById("uploadProgressBar").style.width =
                percentComplete + "%";
              document.getElementById(
                "uploadStatus"
              ).textContent = `ì—…ë¡œë“œ ì¤‘... (${percentComplete}%)`;
            }
          });

          xhr.addEventListener("load", () => {
            if (xhr.status === 200) {
              const response = JSON.parse(xhr.responseText);
              console.log("âœ… ì—…ë¡œë“œ ì™„ë£Œ:", response);
              document.getElementById("uploadStatus").textContent =
                "âœ… ì—…ë¡œë“œ ì™„ë£Œ!";
              setTimeout(() => {
                document.getElementById("uploadProgress").style.display =
                  "none";
              }, 2000);
              alert("ë…¹í™”ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            } else {
              throw new Error("ì—…ë¡œë“œ ì‹¤íŒ¨: " + xhr.status);
            }
          });

          xhr.addEventListener("error", () => {
            throw new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
          });

          const token = getCookie("Authorization");
          console.log("ğŸ”‘ í† í° í™•ì¸:", token ? "ìˆìŒ" : "ì—†ìŒ");

          if (!token) {
            console.error("âŒ Authorization í† í° ì—†ìŒ!");
            alert("ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
            document.getElementById("uploadProgress").style.display = "none";
            return;
          }

          if (currentUserRole === "HOST") {
            xhr.open("POST", `/api/recording/${sessionId}/upload`);
            xhr.setRequestHeader(
              "Authorization",
              token.startsWith("Bearer ") ? token : "Bearer " + token
            );
          } else {
            let lastAnswerId = window.lastAnswerId;

            if (!lastAnswerId) {
              console.warn("âš ï¸ answerId ì—†ìŒ, í´ë§ ì‹œì‘...");
              document.getElementById("uploadStatus").textContent =
                "ë‹µë³€ ID í™•ì¸ ì¤‘...";

              for (let i = 0; i < 10; i++) {
                await new Promise((resolve) => setTimeout(resolve, 500));
                lastAnswerId = window.lastAnswerId;
                if (lastAnswerId) {
                  console.log("âœ… í´ë§ìœ¼ë¡œ answerId íšë“:", lastAnswerId);
                  break;
                }
              }

              if (!lastAnswerId) {
                alert(
                  "ë‹µë³€ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nìŒì„±ìœ¼ë¡œ ë‹µë³€í•œ í›„ 2-3ì´ˆ ëŒ€ê¸° í›„ ë…¹í™”ë¥¼ ì¤‘ì§€í•´ì£¼ì„¸ìš”."
                );
                document.getElementById("uploadProgress").style.display =
                  "none";
                return;
              }
            }

            console.log(
              "ğŸ“¤ ì—…ë¡œë“œ URL:",
              `/api/recording/answer/${lastAnswerId}/upload`
            );
            xhr.open("POST", `/api/recording/answer/${lastAnswerId}/upload`);
            xhr.setRequestHeader(
              "Authorization",
              token.startsWith("Bearer ") ? token : "Bearer " + token
            );
          }

          xhr.send(formData);
        } catch (error) {
          console.error("âŒ ë…¹í™” ì—…ë¡œë“œ ì‹¤íŒ¨:", error);
          document.getElementById("uploadStatus").textContent =
            "âŒ ì—…ë¡œë“œ ì‹¤íŒ¨";
          alert("ë…¹í™” ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
        }
      }

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
        return null;
      }

      window.addEventListener("load", init);
      window.addEventListener("beforeunload", () => {
        if (stompClient) {
          stompClient.disconnect();
        }
      });
    </script>
    <script src="/js/push-init.js"></script>
    <script src="/js/push-notifications.js"></script>
  </body>
</html>
