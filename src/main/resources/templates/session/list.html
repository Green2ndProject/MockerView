<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>세션 목록 - MockerView</title>
    <link rel="stylesheet" href="/css/common.css" />
    <link rel="stylesheet" href="/css/sessionModal.css" />
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <div class="navbar-content">
          <a class="navbar-brand" href="/session/list"> Mockerview </a>
          <div class="navbar-nav">
            <a class="nav-link active" href="/session/list">세션 관리</a>
            <div th:if="${currentUser != null}">
              <a class="nav-link" th:href="@{/auth/mypage}">마이페이지</a>
              <a class="nav-link" th:href="@{/auth/logout}">로그아웃</a>
            </div>
            <div th:if="${currentUser == null}">
              <a class="nav-link" th:href="@{/auth/login}">로그인</a>
              <a class="nav-link" th:href="@{/auth/register}">회원가입</a>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="page-header">
      <div class="container">
        <div class="page-title">
          <h1>실시간 모의면접 세션</h1>
          <button
            th:if="${currentUser != null && userRoleString  == 'HOST'}"
            class="btn btn-primary"
            onclick="createNewSession()"
          >
            + 새 세션 생성
          </button>
        </div>
      </div>
    </div>

    <div class="container">
      <div th:if="${error}" class="alert alert-error">
        <strong>오류:</strong> <span th:text="${error}">에러 메시지</span>
      </div>

      <div th:if="${success}" class="alert alert-success">
        <span th:text="${success}">성공 메시지</span>
      </div>

      <div class="session-grid" th:if="${sessions != null and !sessions.empty}">
        <div th:each="sessionItem : ${sessions}" class="session-card">
          <div class="session-header">
            <div>
              <h3
                class="session-title"
                th:text="${sessionItem.title ?: '모의면접 세션'}"
              >
                모의면접 세션
              </h3>
              <div class="session-meta">
                <span
                  class="badge"
                  th:classappend="${sessionItem.status == 'RUNNING' ? 'badge-live' : (sessionItem.status == 'ENDED' ? 'badge-ended' : 'badge-waiting')}"
                  th:text="${sessionItem.status ?: 'PLANNED'}"
                  >PLANNED</span
                >
              </div>
            </div>
          </div>

          <div class="session-meta" th:if="${sessionItem.host != null}">
            <span>호스트: </span>
            <span
              th:text="${sessionItem.host.name ?: sessionItem.host.username ?: '알 수 없음'}"
              >호스트명</span
            >
          </div>

          <div class="session-meta" th:if="${sessionItem.createdAt != null}">
            <span>생성일: </span>
            <span
              th:text="${#temporals.format(sessionItem.createdAt, 'yyyy-MM-dd HH:mm')}"
              >2025-09-23 10:00</span
            >
          </div>

          <div style="margin-top: 1rem">
            <a
              th:if="${currentUser != null && userRoleString  == 'HOST'}"
              th:href="@{/session/{id}/join(id=${sessionItem.id}, role='HOST')}" 
              class="btn btn-success"
              style="margin-right: 8px"
            >
              면접관으로 참가
            </a>
            <a
              th:if="${currentUser != null && userRoleString  != 'HOST'}"
              th:href="@{/session/{id}/join(id=${sessionItem.id}, role='STUDENT')}" 
              class="btn btn-primary"
            >
              학생으로 참가
            </a>
          </div>
        </div>
      </div>

      <div
        th:if="${sessions == null or sessions.empty}"
        style="text-align: center; padding: 4rem 0"
      >
        <h3 style="color: var(--gray-600); margin-bottom: 1rem">
          현재 진행 중인 세션이 없습니다
        </h3>
        <p style="color: var(--gray-500); margin-bottom: 2rem">
          새로운 세션을 생성하거나 기존 세션이 열릴 때까지 기다려주세요.
        </p>

        <div
          class="card"
          style="max-width: 500px; margin: 0 auto; text-align: left"
        >
          <div class="card-body">
            <h4>테스트 세션</h4>
            <p style="color: var(--gray-600); margin: 0.5rem 0">
              개발 테스트용 모의면접 세션입니다.
            </p>
            <a href="/session/1/join?role=HOST"
              class="btn btn-success"
              style="margin-right: 8px"
              >면접관으로 테스트</a
            >
            <a href="/session/1/join?role=STUDENT" class="btn btn-primary"
              >학생으로 테스트</a
            >
          </div>
        </div>

        <div style="margin-top: 2rem">
          <button onclick="location.reload()" class="btn btn-secondary">
            새로고침
          </button>
        </div>
      </div>
    </div>

    <!-- 모달 컨테이너 추가 planned, running, ended, -->
    <div id="sessionModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>새 세션 생성</h2>
          <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
          <form id="createSessionForm">
            <div class="form-group">
              <label for="sessionTitle">세션 제목</label>
              <input
                type="text"
                id="sessionTitle"
                name="title"
                class="form-control"
                placeholder="모의면접 세션 제목"
                required
              />
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">생성하기</button>
              <button type="button" class="btn btn-secondary close-modal">
                취소
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!--모달 컨테이너  -->
  </body>
  <script>
    function createNewSession() {
      document.getElementById("sessionModal").style.display = "flex";
    }
    // 모달 닫기 이벤트 설정
    document.addEventListener("DOMContentLoaded", function () {
      const modal = document.getElementById("sessionModal");
      const closeBtns = document.getElementsByClassName("close-modal");

      // 닫기 버튼으로 모달 닫기
      for (let i = 0; i < closeBtns.length; i++) {
        closeBtns[i].addEventListener("click", function () {
          modal.style.display = "none";
        });
      }

      // 모달 바깥 영역 클릭시 닫기이
      window.addEventListener("click", function (event) {
        if (event.target === modal) {
          modal.style.display = "none";
        }
      });

      // 폼 제출 처리
      document
        .getElementById("createSessionForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const title = document.getElementById("sessionTitle").value;

          if (title !== null && title.trim() !== "") {
            const form = document.createElement("form");
            form.method = "POST";
            form.action = "/session/create";

            const titleInput = document.createElement("input");
            titleInput.type = "hidden";
            titleInput.name = "title";
            titleInput.value = title.trim();

            form.appendChild(titleInput);
            document.body.appendChild(form);
            form.submit();
          } else {
            alert("세션 제목을 입력해주세요!");
          }
        });
    });
  </script>
</html>