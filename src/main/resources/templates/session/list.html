<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ì„¸ì…˜ ëª©ë¡ - MockerView</title>
    <link rel="stylesheet" href="/css/common.css" />
    <link rel="stylesheet" href="/css/sessionModal.css" />
    <link rel="stylesheet" href="/css/pagination.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
      .search-container {
        margin-bottom: 2rem;
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }
      .search-form {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
      }
      .search-input {
        flex: 1;
        min-width: 300px;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background: white;
        transition: border-color 0.15s ease-in-out;
      }
      .search-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }
      .btn-search, .btn-reset {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 400;
        border: 1px solid;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s ease-in-out;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }
      .btn-search {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }
      .btn-search:hover {
        background: #5568d3;
        border-color: #5568d3;
      }
      .btn-reset {
        background: white;
        color: #6c757d;
        border-color: #6c757d;
      }
      .btn-reset:hover {
        background: #6c757d;
        color: white;
      }
      .search-result-info {
        margin-top: 1rem;
        padding: 0.75rem;
        background: #e7f1ff;
        border-radius: 4px;
        color: #004085;
        border: 1px solid #b3d7ff;
      }
      .section-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        border-bottom: 2px solid #e9ecef;
      }
      .tab-btn {
        padding: 1rem 2rem;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.2s;
      }
      .tab-btn:hover {
        color: #667eea;
      }
      .tab-btn.active {
        color: #667eea;
        border-bottom-color: #667eea;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .quick-action-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }
      .quick-card {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.2s;
      }
      .quick-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }
      .quick-card-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
      }
      .quick-card h3 {
        margin-bottom: 0.5rem;
        color: #212529;
      }
      .quick-card p {
        color: #6c757d;
        margin-bottom: 1.5rem;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <div class="navbar-content">
          <a class="navbar-brand" href="/session/list">Mockerview</a>
          <div class="navbar-nav">
            <a class="nav-link active" href="/session/list">ì„¸ì…˜ ê´€ë¦¬</a>
            <a class="nav-link" th:if="${currentUser != null}" th:href="@{/auth/mypage}">ë§ˆì´í˜ì´ì§€</a>
            <a class="nav-link" th:if="${currentUser != null}" th:href="@{/auth/logout}">ë¡œê·¸ì•„ì›ƒ</a>
          </div>
          <div th:if="${currentUser == null}">
            <a class="nav-link" th:href="@{/auth/login}">ë¡œê·¸ì¸</a>
            <a class="nav-link" th:href="@{/auth/register}">íšŒì›ê°€ì…</a>
          </div>
        </div>
      </div>
    </nav>

    <div class="page-header">
      <div class="container">
        <div class="page-title">
          <h1>MockerView ë©´ì ‘ í”Œë«í¼</h1>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="section-tabs">
        <button class="tab-btn active" onclick="switchTab('group')">
          ğŸ‘¥ ê·¸ë£¹ ë©´ì ‘
        </button>
        <button class="tab-btn" onclick="switchTab('self')">
          ğŸ¯ ì…€í”„ ë©´ì ‘
        </button>
        <button class="tab-btn" onclick="switchTab('review')">
          ğŸ“ ë¦¬ë·°
        </button>
      </div>

      <div id="group-tab" class="tab-content active">
        <div class="quick-action-cards">
          <div class="quick-card">
            <div class="quick-card-icon">ğŸ‘¥</div>
            <h3>ê·¸ë£¹ ë©´ì ‘</h3>
            <p>ì‹¤ì‹œê°„ìœ¼ë¡œ ì—¬ëŸ¬ ëª…ì´ ì°¸ì—¬í•˜ëŠ” ëª¨ì˜ë©´ì ‘</p>
            <button 
              th:if="${currentUser != null and currentUser.role.name() == 'HOST'}"
              class="btn btn-primary"
              onclick="createNewSession()">
              ìƒˆ ì„¸ì…˜ ìƒì„±
            </button>
          </div>
        </div>

        <div class="search-container">
          <form class="search-form" method="get" action="/session/list">
            <input
              type="text"
              id="keyword"
              name="keyword"
              class="search-input"
              placeholder="ì„¸ì…˜ ì œëª© ë˜ëŠ” í˜¸ìŠ¤íŠ¸ëª…ìœ¼ë¡œ ê²€ìƒ‰"
              th:value="${searchDTO?.keyword}"
            />
            <button type="submit" class="btn-search">ê²€ìƒ‰</button>
            <button type="button" class="btn-reset" onclick="resetSearch()">ì´ˆê¸°í™”</button>
          </form>

          <div
            class="search-result-info"
            th:if="${keyword != null and !#strings.isEmpty(keyword)}">
            "<span th:text="${keyword}">ê²€ìƒ‰ì–´</span>" ê²€ìƒ‰ ê²°ê³¼:
            <strong th:text="${#lists.size(sessions)}">0</strong>ê°œì˜ ì„¸ì…˜
          </div>
        </div>

        <div th:if="${error}" class="alert alert-error">
          <strong>ì˜¤ë¥˜:</strong> <span th:text="${error}">ì—ëŸ¬ ë©”ì‹œì§€</span>
        </div>

        <div th:if="${success}" class="alert alert-success">
          <span th:text="${success}">ì„±ê³µ ë©”ì‹œì§€</span>
        </div>

        <div class="session-grid" th:if="${sessions != null and !sessions.empty}">
          <div
            th:each="sessionItem : ${sessions}"
            class="session-card"
            th:attr="data-session-id=${sessionItem.id}">
            <div class="session-header">
              <div>
                <h3
                  class="session-title"
                  th:text="${sessionItem.title != null ? sessionItem.title : 'ëª¨ì˜ë©´ì ‘ ì„¸ì…˜'}">
                  ëª¨ì˜ë©´ì ‘ ì„¸ì…˜
                </h3>
                <div class="session-meta">
                  <span
                    class="badge"
                    th:classappend="${sessionItem.status == 'RUNNING' ? 'badge-live' : (sessionItem.status == 'ENDED' ? 'badge-ended' : 'badge-waiting')}"
                    th:text="${sessionItem.status != null ? sessionItem.status : 'PLANNED'}">
                    PLANNED
                  </span>
                </div>
              </div>
            </div>

            <div class="session-meta" th:if="${sessionItem.host != null}">
              <span>í˜¸ìŠ¤íŠ¸: </span>
              <span
                th:text="${sessionItem.host.name != null ? sessionItem.host.name : (sessionItem.host.username != null ? sessionItem.host.username : 'ì•Œ ìˆ˜ ì—†ìŒ')}">
                í˜¸ìŠ¤íŠ¸ëª…
              </span>
            </div>

            <div class="session-meta" th:if="${sessionItem.createdAt != null}">
              <span>ìƒì„±ì¼: </span>
              <span
                th:text="${#temporals.format(sessionItem.createdAt, 'yyyy-MM-dd HH:mm')}">
                2025-09-23 10:00
              </span>
            </div>

            <div style="margin-top: 1rem">
              <a
                th:if="${currentUser != null and currentUser.role.name() == 'HOST'}"
                th:href="@{/session/{id}/join(id=${sessionItem.id}, role='HOST')}"
                class="btn btn-success"
              >
                ë©´ì ‘ê´€ìœ¼ë¡œ ì°¸ê°€
              </a>
              <a
                th:if="${currentUser != null and currentUser.role.name() == 'STUDENT'}"
                th:href="@{/session/{id}/join(id=${sessionItem.id}, role='STUDENT')}"
                class="btn btn-primary"
              >
                í•™ìƒìœ¼ë¡œ ì°¸ê°€
              </a>
              <a
                th:if="${currentUser != null and currentUser.role.name() == 'REVIEWER'}"
                th:href="@{/session/{id}/join(id=${sessionItem.id}, role='REVIEWER')}"
                class="btn btn-info"
              >
                ë¦¬ë·°ì–´ë¡œ ì°¸ê°€
              </a>
              <div
                th:if="${currentUser == null}"
                style="text-align: center; color: #6c757d"
              >
                ë¡œê·¸ì¸ í›„ ì°¸ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
              </div>
            </div>
          </div>
        </div>

        <div
          th:if="${sessions == null or sessions.empty}"
          style="text-align: center; padding: 4rem 0">
          <h3 style="color: var(--gray-600); margin-bottom: 1rem">
            í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤
          </h3>
          <p style="color: var(--gray-500); margin-bottom: 2rem">
            ìƒˆë¡œìš´ ì„¸ì…˜ì„ ìƒì„±í•˜ê±°ë‚˜ ê¸°ì¡´ ì„¸ì…˜ì´ ì—´ë¦´ ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
          </p>
        </div>
      </div>

      <div id="self-tab" class="tab-content">
        <div class="quick-action-cards">
          <div class="quick-card">
            <div class="quick-card-icon">ğŸ¯</div>
            <h3>ì…€í”„ ë©´ì ‘ ì‹œì‘</h3>
            <p>í˜¼ì ì—°ìŠµí•˜ê³  AI í”¼ë“œë°± ë°›ê¸°</p>
            <a href="/selfinterview/create" class="btn btn-primary">ì‹œì‘í•˜ê¸°</a>
          </div>
          <div class="quick-card">
            <div class="quick-card-icon">ğŸ“Š</div>
            <h3>ë‚´ ì—°ìŠµ ê¸°ë¡</h3>
            <p>ì§€ë‚œ ì…€í”„ ë©´ì ‘ ê²°ê³¼ ë³´ê¸°</p>
            <a href="/selfinterview/list" class="btn btn-secondary">ë³´ëŸ¬ê°€ê¸°</a>
          </div>
        </div>

        <div style="text-align: center; padding: 3rem; background: #f8f9fa; border-radius: 8px;">
          <h3>ì…€í”„ ë©´ì ‘ ê¸°ëŠ¥</h3>
          <ul style="list-style: none; padding: 0; margin: 1.5rem 0;">
            <li style="margin: 0.5rem 0;">âœ… ëœë¤ ì§ˆë¬¸ ìë™ ìƒì„±</li>
            <li style="margin: 0.5rem 0;">âœ… AI ì‹¤ì‹œê°„ í”¼ë“œë°±</li>
            <li style="margin: 0.5rem 0;">âœ… ê°•ì /ì•½ì  ë¶„ì„</li>
            <li style="margin: 0.5rem 0;">âœ… ë‹µë³€ ê¸°ë¡ ì €ì¥</li>
          </ul>
        </div>
      </div>

      <div id="review-tab" class="tab-content">
        <div class="quick-action-cards">
          <div class="quick-card">
            <div class="quick-card-icon">ğŸ“</div>
            <h3>ë¦¬ë·° ê°€ëŠ¥í•œ ì„¸ì…˜</h3>
            <p>ì¢…ë£Œëœ ë©´ì ‘ì— í”¼ë“œë°± ì‘ì„±í•˜ê¸°</p>
            <a href="/review/list" class="btn btn-primary">ë¦¬ë·°í•˜ëŸ¬ ê°€ê¸°</a>
          </div>
          <div class="quick-card">
            <div class="quick-card-icon">â­</div>
            <h3>ë‚´ê°€ ì‘ì„±í•œ ë¦¬ë·°</h3>
            <p>ë‚´ê°€ ë‚¨ê¸´ í”¼ë“œë°± ë³´ê¸°</p>
            <a href="/review/my" class="btn btn-secondary">í™•ì¸í•˜ê¸°</a>
          </div>
        </div>

        <div style="text-align: center; padding: 3rem; background: #f8f9fa; border-radius: 8px;">
          <h3>ë¦¬ë·° ì‹œìŠ¤í…œ</h3>
          <ul style="list-style: none; padding: 0; margin: 1.5rem 0;">
            <li style="margin: 0.5rem 0;">âœ… ë©´ì ‘ ì¢…ë£Œ í›„ ì—´ëŒ ê°€ëŠ¥</li>
            <li style="margin: 0.5rem 0;">âœ… ìƒì„¸ í”¼ë“œë°± ì‘ì„±</li>
            <li style="margin: 0.5rem 0;">âœ… í‰ì  ì‹œìŠ¤í…œ (0.0~5.0)</li>
            <li style="margin: 0.5rem 0;">âœ… íŒ€ì›/ë©˜í†  í”¼ë“œë°± ì¶•ì </li>
          </ul>
        </div>
      </div>
    </div>

    <div id="sessionModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ìƒˆ ì„¸ì…˜ ìƒì„±</h2>
          <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
          <form id="createSessionForm">
            <div class="form-group">
              <label for="sessionTitle">ì„¸ì…˜ ì œëª©</label>
              <input
                type="text"
                id="sessionTitle"
                name="title"
                class="form-control"
                placeholder="ëª¨ì˜ë©´ì ‘ ì„¸ì…˜ ì œëª©"
                required
              />
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">ìƒì„±í•˜ê¸°</button>
              <button type="button" class="btn btn-secondary close-modal">ì·¨ì†Œ</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="pagination hidden" id="pagination">
      <button class="btn btn-outline btn-sm" id="prev-btn" disabled>ì´ì „</button>
      <div class="page-numbers" id="page-numbers"></div>
      <button class="btn btn-outline btn-sm" id="next-btn">ë‹¤ìŒ</button>
    </div>

    <script th:src="@{/js/pagination.js}"></script>
    <script th:inline="javascript">
      const serverCurrentPage = /*[[${serverCurrentPage}]]*/ 1;
      const serverTotalPages = /*[[${totalPages}]]*/ 1;
      const itemsPerPage = 6;

      function hideElement(element) {
        if (element) element.classList.add("hidden");
      }
      function showElement(element) {
        if (element) element.classList.remove("hidden");
      }

      function onPageChange(page) {
        const url = new URL(window.location.href);
        url.searchParams.set("page", page);
        url.searchParams.set("size", itemsPerPage);
        window.location.href = url.toString();
      }

      window.addEventListener("load", () => {
        const paginationContainer = document.getElementById("pagination");
        if (serverTotalPages > 1) {
          showElement(paginationContainer);
        } else {
          hideElement(paginationContainer);
        }
        createPagination(
          serverCurrentPage || 1,
          serverTotalPages || 1,
          onPageChange,
          "#pagination"
        );
      });

      function switchTab(tabName) {
        document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(content => content.classList.remove("active"));
        
        event.target.classList.add("active");
        document.getElementById(tabName + "-tab").classList.add("active");
      }

      function createNewSession() {
        document.getElementById("sessionModal").style.display = "flex";
      }

      function resetSearch() {
        window.location.href = "/session/list";
      }

      const sessions = /*[[${sessions}]]*/ [];
      let stompClient = null;

      function connect() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);
        stompClient.connect({}, onConnected, onError);
      }

      function onConnected() {
        console.log("WebSocket ì—°ê²° ì„±ê³µ.");
        if (sessions) {
          sessions.forEach((session) => {
            if (session && session.id) {
              stompClient.subscribe(
                `/topic/session/${session.id}/status`,
                onSessionStatusReceived
              );
              console.log(`[WebSocket] ì„¸ì…˜ ${session.id} ìƒíƒœ í† í”½ êµ¬ë… ì™„ë£Œ.`);
            }
          });
        }
      }

      function onError(error) {
        console.error("WebSocket ì—°ê²° ì‹¤íŒ¨:", error);
      }

      function onSessionStatusReceived(payload) {
        try {
          const statusMessage = JSON.parse(payload.body);
          const sessionId = statusMessage.sessionId;
          const newStatus = statusMessage.status;

          const sessionCard = document.querySelector(
            `.session-card[data-session-id='${sessionId}']`
          );

          if (sessionCard) {
            const badge = sessionCard.querySelector(".session-meta .badge");
            if (badge) {
              badge.textContent = newStatus;
              badge.classList.remove("badge-waiting", "badge-live", "badge-ended");
              if (newStatus === "RUNNING") {
                badge.classList.add("badge-live");
              } else if (newStatus === "ENDED") {
                badge.classList.add("badge-ended");
              } else {
                badge.classList.add("badge-waiting");
              }
            }
          }
        } catch (e) {
          console.error("ì„¸ì…˜ ìƒíƒœ ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:", e);
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById("sessionModal");
        const closeBtns = document.getElementsByClassName("close-modal");

        for (let i = 0; i < closeBtns.length; i++) {
          closeBtns[i].addEventListener("click", function () {
            modal.style.display = "none";
          });
        }

        window.addEventListener("click", function (event) {
          if (event.target === modal) {
            modal.style.display = "none";
          }
        });

        document
          .getElementById("createSessionForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            const title = document.getElementById("sessionTitle").value;
            if (title !== null && title.trim() !== "") {
              const form = document.createElement("form");
              form.method = "POST";
              form.action = "/session/create";
              const titleInput = document.createElement("input");
              titleInput.type = "hidden";
              titleInput.name = "title";
              titleInput.value = title.trim();
              form.appendChild(titleInput);
              document.body.appendChild(form);
              form.submit();
            } else {
              alert("ì„¸ì…˜ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            }
          });

        connect();
      });
    </script>
  </body>
</html>